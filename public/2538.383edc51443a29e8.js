"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2538],{2538:(ne,b,h)=>{h.r(b),h.d(b,{QuestionFormPageModule:()=>V});var I=h(6895),S=h(433),m=h(4731),p=h(655),T=h(7423),Q=h(4464),v=h(313),x=h(7368),e=h(8256),F=h(5757),y=h(2628),w=h(1433),A=h(6250),C=h(6280),P=h(1229),E=h(2414),Z=h(2424),N=h(1481),q=h(6769);function k(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-item",21)(1,"ion-input",22),e.NdJ("ionChange",function(s){e.CHM(i);const r=e.oxw(2),g=r.$implicit,a=r.index,t=e.oxw();return e.KtG(t.onAnswerChange(s,g,a))}),e.qZA()()}if(2&o){const i=e.oxw(2).$implicit;e.xp6(1),e.Q6J("autofocus",!0)("clearInput",!0)("autocomplete",!0)("value",i.answer)}}function J(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-input",24),e.NdJ("ionChange",function(s){e.CHM(i);const r=e.oxw(3),g=r.$implicit,a=r.index,t=e.oxw();return e.KtG(t.onAnswerChange(s,g,a))}),e.qZA()}if(2&o){const i=e.oxw(3).$implicit;e.Q6J("autofocus",!0)("clearInput",!0)("autocomplete",!0)("value",i.answer)}}function U(o,l){if(1&o&&(e.TgZ(0,"ion-item",21),e.YNc(1,J,1,4,"ion-input",23),e.qZA()),2&o){const i=e.oxw(2).$implicit;e.xp6(1),e.Q6J("ngIf","ONEDIGIT"===i.answers)}}function Y(o,l){if(1&o&&(e.TgZ(0,"ion-radio",28),e._uU(1),e.qZA()),2&o){const i=l.$implicit;e.Q6J("value",i.v),e.xp6(1),e.Oqu(i.t)}}function G(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-item",25)(1,"ion-radio-group",26),e.NdJ("ionChange",function(s){e.CHM(i);const r=e.oxw(2),g=r.$implicit,a=r.index,t=e.oxw();return e.KtG(t.onAnswerChange(s,g,a))}),e.YNc(2,Y,2,2,"ion-radio",27),e._UZ(3,"br"),e.qZA()()}if(2&o){const i=e.oxw(2).$implicit,n=e.oxw();e.xp6(1),e.Q6J("value",+i.answer),e.xp6(1),e.Q6J("ngForOf",n.jsonCast(i.answers))}}function W(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-button",29),e.NdJ("click",function(){e.CHM(i);const s=e.oxw(2),r=s.index,g=s.$implicit,a=e.oxw();return e.KtG(a.onSelectPhoto(r,g.id))}),e._UZ(1,"ion-icon",30),e.qZA()}if(2&o){const i=e.oxw(2).index,n=e.oxw();e.Q6J("disabled",!n.ImageSrc[i].canTakePickture||!!n.ImageSrc[i].url)}}function $(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-button",31),e.NdJ("click",function(){e.CHM(i);const s=e.oxw(2).$implicit,r=e.oxw();return e.KtG(r.openedPopover=s.indx)}),e._UZ(1,"ion-icon",32),e.qZA()}}function L(o,l){if(1&o&&(e.TgZ(0,"ion-content",33),e._uU(1),e.qZA()),2&o){const i=e.oxw(2).$implicit;e.xp6(1),e.Oqu(i.popup)}}function O(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-row",34)(1,"ion-col")(2,"img",35),e.NdJ("click",function(){e.CHM(i);const s=e.oxw(2).index,r=e.oxw();return e.KtG(r.onImgClicked(s))}),e.qZA()()()}if(2&o){const i=e.oxw(2).index,n=e.oxw();e.xp6(2),e.Q6J("src",n.ImageSrc[i].url,e.LSH)}}function z(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"div",12)(1,"div",13)(2,"div"),e._uU(3),e.YNc(4,k,2,4,"ion-item",14),e.YNc(5,U,2,1,"ion-item",14),e.YNc(6,G,4,2,"ion-item",15),e.qZA(),e.TgZ(7,"div",16),e.YNc(8,W,2,1,"ion-button",17),e.YNc(9,$,2,0,"ion-button",18),e.TgZ(10,"ion-popover",19),e.NdJ("didDismiss",function(){e.CHM(i);const s=e.oxw(2);return e.KtG(s.openedPopover=0)}),e.YNc(11,L,2,1,"ng-template"),e.qZA()()(),e.YNc(12,O,3,1,"ion-row",20),e.qZA()}if(2&o){const i=e.oxw(),n=i.$implicit,s=i.index,r=e.oxw();e.xp6(2),e.Tol(n.popup||n.has_evidence?"col-10":"col ion-text-justify"),e.xp6(1),e.hij(" ",n.uid+".- "+n.sentence," "),e.xp6(1),e.Q6J("ngIf","FREETEXT"===n.answers),e.xp6(1),e.Q6J("ngIf","ONEDIGIT"===n.answers),e.xp6(1),e.Q6J("ngIf","FREETEXT"!==n.answers&&"ONEDIGIT"!==n.answers),e.xp6(2),e.Q6J("ngIf",n.has_evidence),e.xp6(1),e.Q6J("ngIf",n.popup),e.xp6(1),e.Q6J("isOpen",r.openedPopover===n.indx),e.xp6(2),e.Q6J("ngIf",r.ImageSrc[s].url)}}function D(o,l){if(1&o&&(e.TgZ(0,"div"),e.YNc(1,z,13,10,"div",11),e.qZA()),2&o){const i=l.index,n=e.oxw();e.xp6(1),e.Q6J("ngIf",!n.hideQuestion[i])}}function H(o,l){if(1&o&&(e.TgZ(0,"ion-row",36)(1,"ion-col")(2,"p",4)(3,"strong"),e._uU(4),e.qZA()()(),e.TgZ(5,"ion-col")(6,"p",4)(7,"strong"),e._uU(8),e.qZA()()()()),2&o){const i=e.oxw();e.xp6(4),e.AsE("Secci\xf3n ",i.sectionIndex+1,"/",i.sectionIds.length,""),e.xp6(4),e.AsE("",i.answerCount,"/",i.showedQuestions," Respuestas")}}function K(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-button",37),e.NdJ("click",function(){e.CHM(i);const s=e.oxw();return e.KtG(s.onPrevious())}),e._uU(1,"ANTERIOR"),e.qZA()}}function M(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-button",38),e.NdJ("click",function(){e.CHM(i);const s=e.oxw();return e.KtG(s.onNext())}),e._uU(1,"SIGUIENTE"),e.qZA()}if(2&o){const i=e.oxw();e.Q6J("disabled",!i.canNext)}}function j(o,l){if(1&o){const i=e.EpF();e.TgZ(0,"ion-button",38),e.NdJ("click",function(){e.CHM(i);const s=e.oxw();return e.KtG(s.onFinish())}),e._uU(1,"FINALIZAR"),e.qZA()}if(2&o){const i=e.oxw();e.Q6J("disabled",!i.canNext)}}let B=(()=>{class o{constructor(i,n,s,r,g,a,t,d,c,_,u,f){this.questionService=i,this.answerService=n,this.route=s,this.router=r,this.photoService=g,this.confirmDialogService=a,this.answerEvidenceService=t,this.responseService=d,this.loadingService=c,this.actionSheetCtrl=_,this.sanitization=u,this.platform=f,this.auditoryId="0",this.sectionId="0",this.sectionName="",this.subsectionName="",this.openedPopover=0,this.questions=[],this.ImageSrc=[],this.answerCount=0,this.hideForm=!0,this.sectionIds=[],this.sectionIndex=0,this.backUri=(0,x.CE)(),this.hasConditionQuestions=!1,this.questionChangeEvent=[],this.hideQuestion=[],this.questionsWithCondition=[],this.showedQuestions=0,this.sameAnswer=[],this.canNext=!1,this.platform.backButton.subscribeWithPriority(9999,()=>{this.router.navigateByUrl(this.backUri)})}ngOnInit(){this.route.paramMap.subscribe({next:i=>{(!i.has("sectionId")||!i.has("auditoryId"))&&this.router.navigateByUrl(this.backUri),this.auditoryId=`${i.get("auditoryId")}`,this.sectionId=`${i.get("sectionId")}`,this.backUri="0"===i.get("from")?(0,x.bD)(this.auditoryId):(0,x.Zh)("local"),this.questionService.getSectionIds().subscribe({next:n=>{n!==v.W&&setTimeout(()=>{this.sectionIds=n.values.map(s=>s.id),this.sectionIndex=this.sectionIds.findIndex(s=>+s==+this.sectionId),this.fetchSection()},20)}})}}).unsubscribe()}ionViewWillEnter(){}onNext(){this.sectionIndex<this.sectionIds.length&&(this.sectionIndex++,this.sectionId=""+ +this.sectionIds[this.sectionIndex],this.fetchSection())}onPrevious(){0!==this.sectionIndex&&(this.sectionIndex--,this.sectionId=""+ +this.sectionIds[this.sectionIndex],this.fetchSection())}fetchSection(){this.hideForm=!0,this.questionService.getSection(this.sectionId).subscribe({next:i=>{i!==v.W&&setTimeout(()=>{this.loadingService.showLoading();const n=i.values[0];this.sectionName=n.name,this.subsectionName=n.subname,this.questionService.getLocalQuestionsBySection(this.sectionId,this.auditoryId).subscribe({next:s=>{s!==v.W&&setTimeout(()=>{this.questions=s.values,this.hideQuestion=this.questions.map(t=>t.cond&&""!==t.cond&&t.cond.startsWith("S")),this.showedQuestions=this.hideQuestion.filter(t=>!0!==t).length,this.hasConditionQuestions=!!this.questions.find(t=>t.cond&&""!==t.cond),this.questionsWithCondition=this.questions.map((t,d)=>{if(t.cond){const c=t.cond.split("-");return{questionId:t.id,questionIndex:d,type:c[0],section:c[1],question:c[2],answer:c[3]}}return null}).filter(t=>null!==t),this.questionChangeEvent=this.questionsWithCondition.map(t=>({uid:t.question,affectedIndexes:this.questionsWithCondition.filter(d=>d.question===t.question).map(d=>d.questionIndex)})).filter((t,d,c)=>c.findIndex(_=>_.uid===t.uid)===d),this.questionChangeEvent.forEach((t,d)=>{setTimeout(()=>{this.answerService.answerExists(t.uid,this.auditoryId).subscribe({next:c=>{c!==v.W&&c.values.length>0&&this.verifyCondition(t.uid,c.values[0].value)}})},20*d)});const r=20*this.questionChangeEvent.length,g=this.questions.filter(t=>t.cond&&""!==t.cond&&t.cond.startsWith("E"));g.forEach((t,d)=>{setTimeout(()=>{this.answerService.answerExists(t.cond.split("-")[2],this.auditoryId).subscribe({next:c=>{c!==v.W&&(t.answer=c.values[0].value,setTimeout(()=>{this.answerService.saveAnswer(t.id,this.auditoryId,t.answer).subscribe({next:_=>{if(_!==v.W){const u=this.questions.findIndex(f=>f.id===t.id);this.ImageSrc[u].canTakePickture=!0,this.alreadyAnsweredAll()}}})},r+40*d-20))}})},r+40*d)});const a=r+40*g.length;this.questions.filter(t=>t.cond&&""!==t.cond&&t.cond.startsWith("D")).forEach((t,d)=>{setTimeout(()=>{const c=t.cond.split("-");this.answerService.answerExists(c[2],this.auditoryId).subscribe({next:_=>{if(_!==v.W){const u=c[3].split(":");let f="";switch(u[0]){case"<":f=+_.values[0].value<+u[1]?u[2]:u[3];break;case"<=":f=+_.values[0].value<=+u[1]?u[2]:u[3];break;case">":f=+_.values[0].value>+u[1]?u[2]:u[3];break;case">=":f=+_.values[0].value>=+u[1]?u[2]:u[3];break;case"=":f=+_.values[0].value==+u[1]?u[2]:u[3];break;case"!=":f=+_.values[0].value!=+u[1]?u[2]:u[3]}t.answer=f,setTimeout(()=>{this.answerService.saveAnswer(t.id,this.auditoryId,f).subscribe({next:ee=>{if(ee!==v.W){const ie=this.questions.findIndex(te=>te.id===t.id);this.ImageSrc[ie].canTakePickture=!0,this.alreadyAnsweredAll()}}})},a+40*d-20)}}})},a+40*d)}),this.ImageSrc=this.questions.map(t=>({canTakePickture:!!t.answer,url:"",id:t.dir?t.dir:""})),(0,Q.n$)("hybrid")?this.ImageSrc.forEach((t,d)=>{t.id&&this.photoService.getLocalAnswerEvidenceUri(t.id).then(c=>{this.ImageSrc[d].url=T.dV.convertFileSrc(c.uri)})}):this.ImageSrc.forEach((t,d)=>{t.id&&this.photoService.getLocalAnswerEvidence(t.id).then(c=>{this.ImageSrc[d].url=this.sanitization.bypassSecurityTrustUrl("data:image/jpeg;base64,"+c.data)})}),this.alreadyAnsweredAll(),this.hideForm=!1},20)}})},20)}})}jsonCast(i){return JSON.parse(i)}onSelectPhoto(i,n){return(0,p.mG)(this,void 0,void 0,function*(){yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:[{text:"C\xe1mara",handler:()=>this.fromCamera(i,n)},{text:"Galer\xeda",handler:()=>this.fromGallery(i,n)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]})).present()})}fromGallery(i,n){this.photoService.openGallery().then(s=>(0,p.mG)(this,void 0,void 0,function*(){for(let r=0;r<s.photos.length;r++){const g=s.photos[r].webPath,a=yield fetch(g).then(t=>t.blob());this.photoService.saveLocalAnswerEvidence(a,this.auditoryId,this.sectionId).then(t=>{this.answerEvidenceService.localSave({auditoryId:this.auditoryId,questionId:n,dir:t}).subscribe({next:d=>(0,p.mG)(this,void 0,void 0,function*(){d!==v.W&&setTimeout(()=>{this.answerEvidenceService.getLastInsertedDir().subscribe({next:c=>(0,p.mG)(this,void 0,void 0,function*(){c!==v.W&&(this.ImageSrc[i].url=this.sanitization.bypassSecurityTrustUrl(g),this.ImageSrc[i].id=c.values[0].dir)})})},20)}),error:d=>{this.responseService.onError(d,"No se pudo guardar una imagen")}})})}}))}fromCamera(i,n){this.photoService.takePicture().then(s=>(0,p.mG)(this,void 0,void 0,function*(){const r=s.webPath||"",g=yield fetch(r).then(a=>a.blob());this.photoService.saveLocalAnswerEvidence(g,this.auditoryId,this.sectionId).then(a=>{this.answerEvidenceService.localSave({auditoryId:this.auditoryId,questionId:n,dir:a}).subscribe({next:t=>(0,p.mG)(this,void 0,void 0,function*(){t!==v.W&&setTimeout(()=>{this.answerEvidenceService.getLastInsertedDir().subscribe({next:d=>(0,p.mG)(this,void 0,void 0,function*(){d!==v.W&&(this.ImageSrc[i].url=this.sanitization.bypassSecurityTrustUrl(r),this.ImageSrc[i].id=d.values[0].dir)})})},20)}),error:t=>{this.responseService.onError(t,"No se pudo guardar una imagen")}})})}))}onImgClicked(i){this.confirmDialogService.presentAlert("\xbfDesea eliminar la imagen?",()=>{this.photoService.removeLocalAnswerEvidence(this.ImageSrc[i].id).then(()=>{this.ImageSrc[i]={canTakePickture:!0,url:"",id:""}})})}onAnswerChange(i,n,s){i.detail.value?this.answerService.saveAnswer(n.id,this.auditoryId,i.detail.value).subscribe({next:r=>{r!==v.W&&(this.ImageSrc[s].canTakePickture=!0,this.alreadyAnsweredAll())}}):(this.ImageSrc[s].canTakePickture=!1,this.alreadyAnsweredAll()),this.verifyCondition(n.uid,`${i.detail.value}`)}verifyCondition(i,n){const s=this.questionChangeEvent.find(r=>`${i}`===r.uid);if(s){this.hideForm=!0;let r=0,g=0;s.affectedIndexes.forEach((a,t)=>{const d=this.questionsWithCondition.find(c=>"S"===c.type&&c.questionIndex===a);this.hideQuestion[a]=d&&d.answer!==n,!0===this.hideQuestion[a]?(g++,setTimeout(()=>{this.ImageSrc[a].id&&""!==this.ImageSrc[a].id?this.photoService.removeLocalAnswerEvidence(this.ImageSrc[a].id).then(()=>{this.answerService.deleteAnswer(this.questions[a].id,this.auditoryId).subscribe({next:c=>{c!==v.W&&(this.ImageSrc[a].canTakePickture=!1,this.questions[a].answer=void 0,this.hideForm=!0,this.showedQuestions=this.hideQuestion.filter(_=>!0!==_).length,r++,r===s.affectedIndexes.length&&(this.hideForm=!1,this.loadingService.dismissLoading()))}})}):this.answerService.deleteAnswer(this.questions[a].id,this.auditoryId).subscribe({next:c=>{c!==v.W&&(this.ImageSrc[a].canTakePickture=!1,this.questions[a].answer=void 0,this.showedQuestions=this.hideQuestion.filter(_=>!0!==_).length,r++,r===s.affectedIndexes.length&&(this.hideForm=!1,this.loadingService.dismissLoading()))}})},50*t)):(this.showedQuestions=this.hideQuestion.filter(c=>!0!==c).length,r++,r===s.affectedIndexes.length&&(this.hideForm=!1,this.loadingService.dismissLoading())),this.alreadyAnsweredAll()})}}alreadyAnsweredAll(){this.answerCount=0,this.ImageSrc.forEach(i=>(!0===i.canTakePickture&&this.answerCount++,i.canTakePickture)),this.canNext=this.answerCount===this.showedQuestions,this.loadingService.dismissLoading(),this.loadingService.dismissLoading(),this.loadingService.dismissLoading(),this.hideForm=!1}onFinish(){this.router.navigateByUrl((0,x.Zh)("local"))}}return o.\u0275fac=function(i){return new(i||o)(e.Y36(F.a),e.Y36(y.P),e.Y36(w.gz),e.Y36(w.F0),e.Y36(A.T),e.Y36(C.D),e.Y36(P.N),e.Y36(E.J),e.Y36(Z.b),e.Y36(m.BX),e.Y36(N.H7),e.Y36(m.t4))},o.\u0275cmp=e.Xpm({type:o,selectors:[["app-question-form"]],decls:19,vars:9,consts:[[1,"ion-no-border"],["homeUrl","/home",3,"backUrl"],[1,"principal","col-md-6","col-xl-12","mr-auto","mb-4"],[1,"mx-2","mt-2"],[1,"text-center"],[1,"ion-padding-horizontal"],[3,"hidden"],[4,"ngFor","ngForOf"],["class","mt-2",4,"ngIf"],["expand","full",3,"click",4,"ngIf"],["expand","full",3,"disabled","click",4,"ngIf"],["class","mt-2 mb-2",4,"ngIf"],[1,"mt-2","mb-2"],[1,"row"],["class","txtInput",4,"ngIf"],["lines","none",4,"ngIf"],[1,"col-2"],["size","small",3,"disabled","click",4,"ngIf"],["size","small",3,"click",4,"ngIf"],[3,"isOpen","didDismiss"],["class","mt-3",4,"ngIf"],[1,"txtInput"],[3,"autofocus","clearInput","autocomplete","value","ionChange"],["maxlength","1","type","number",3,"autofocus","clearInput","autocomplete","value","ionChange",4,"ngIf"],["maxlength","1","type","number",3,"autofocus","clearInput","autocomplete","value","ionChange"],["lines","none"],[1,"ion-no-border",3,"value","ionChange"],["justify","start","label-placement","end","mode","md",3,"value",4,"ngFor","ngForOf"],["justify","start","label-placement","end","mode","md",3,"value"],["size","small",3,"disabled","click"],["slot","icon-only","name","camera",2,"font-size","15px"],["size","small",3,"click"],["slot","icon-only","name","help",2,"font-size","15px"],[1,"ion-padding","ion-text-justify"],[1,"mt-3"],["width","100%",3,"src","click"],[1,"mt-2"],["expand","full",3,"click"],["expand","full",3,"disabled","click"]],template:function(i,n){1&i&&(e.TgZ(0,"ion-header",0),e._UZ(1,"app-header-buttons",1),e.TgZ(2,"div",2)(3,"div",3)(4,"h5",4),e._uU(5),e.qZA(),e.TgZ(6,"h6",4),e._uU(7),e.qZA()()()(),e.TgZ(8,"ion-content",5)(9,"div",6),e.YNc(10,D,2,1,"div",7),e.qZA()(),e.TgZ(11,"ion-footer"),e.YNc(12,H,9,4,"ion-row",8),e.TgZ(13,"ion-row")(14,"ion-col"),e.YNc(15,K,2,0,"ion-button",9),e.qZA(),e.TgZ(16,"ion-col"),e.YNc(17,M,2,1,"ion-button",10),e.YNc(18,j,2,1,"ion-button",10),e.qZA()()()),2&i&&(e.xp6(1),e.Q6J("backUrl",n.backUri),e.xp6(4),e.Oqu(n.sectionName),e.xp6(2),e.Oqu(n.subsectionName),e.xp6(2),e.Q6J("hidden",n.hideForm),e.xp6(1),e.Q6J("ngForOf",n.questions),e.xp6(2),e.Q6J("ngIf",n.questions),e.xp6(3),e.Q6J("ngIf",0!==n.sectionIndex),e.xp6(2),e.Q6J("ngIf",n.sectionIndex!==n.sectionIds.length-1),e.xp6(1),e.Q6J("ngIf",n.sectionIndex===n.sectionIds.length-1))},dependencies:[I.sg,I.O5,m.YG,m.wI,m.W2,m.fr,m.Gu,m.gu,m.pK,m.Ie,m.B7,m.se,m.Nd,m.d8,m.as,m.U5,m.QI,m.j9,q.$],encapsulation:2}),o})();var R=h(1576);const X=[{path:"",component:B}];let V=(()=>{class o{}return o.\u0275fac=function(i){return new(i||o)},o.\u0275mod=e.oAB({type:o}),o.\u0275inj=e.cJS({imports:[I.ez,S.UX,m.Pc,w.Bz.forChild(X),R.Y]}),o})()}}]);