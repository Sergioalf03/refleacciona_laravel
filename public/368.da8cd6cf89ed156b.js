"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[368],{76:(b,p,r)=>{r.d(p,{GW:()=>c,dk:()=>g,oK:()=>o});var o=(()=>{return(v=o||(o={})).Prompt="PROMPT",v.Camera="CAMERA",v.Photos="PHOTOS",o;var v})(),c=(()=>{return(v=c||(c={})).Rear="REAR",v.Front="FRONT",c;var v})(),g=(()=>{return(v=g||(g={})).Uri="uri",v.Base64="base64",v.DataUrl="dataUrl",g;var v})()},1443:(b,p,r)=>{r.d(p,{ez:()=>c,tP:()=>o});var o=(()=>{return(i=o||(o={})).Documents="DOCUMENTS",i.Data="DATA",i.Library="LIBRARY",i.Cache="CACHE",i.External="EXTERNAL",i.ExternalStorage="EXTERNAL_STORAGE",o;var i})(),c=(()=>{return(i=c||(c={})).UTF8="utf8",i.ASCII="ascii",i.UTF16="utf16",c;var i})()},1067:(b,p,r)=>{r.d(p,{ez:()=>c.ez,fy:()=>g,tP:()=>c.tP});var o=r(7423),c=r(1443);const g=(0,o.fo)("Filesystem",{web:()=>r.e(6364).then(r.bind(r,6364)).then(v=>new v.FilesystemWeb)})},6769:(b,p,r)=>{r.d(p,{$:()=>f});var o=r(8256),c=r(1433),g=r(6895),v=r(4731);function i(t,s){if(1&t){const a=o.EpF();o.TgZ(0,"div",3)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(a);const u=o.oxw();return o.KtG(u.onGoingBack())}),o._UZ(2,"ion-icon",5),o.qZA()()}}function C(t,s){if(1&t){const a=o.EpF();o.TgZ(0,"div",6)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(a);const u=o.oxw();return o.KtG(u.onGoingHome())}),o._UZ(2,"ion-icon",7),o.qZA()()}}function y(t,s){if(1&t){const a=o.EpF();o.TgZ(0,"div",6)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(a);const u=o.oxw();return o.KtG(u.customButton.click())}),o._UZ(2,"ion-icon",8),o.qZA()()}if(2&t){const a=o.oxw();o.xp6(2),o.Q6J("name",a.customButton.icon)}}let f=(()=>{class t{constructor(a){this.router=a}ngOnInit(){}onGoingHome(){this.router.navigateByUrl(this.homeUrl)}onGoingBack(){this.router.navigateByUrl(this.backUrl)}}return t.\u0275fac=function(a){return new(a||t)(o.Y36(c.F0))},t.\u0275cmp=o.Xpm({type:t,selectors:[["app-header-buttons"]],inputs:{homeUrl:"homeUrl",backUrl:"backUrl",customButton:"customButton"},decls:4,vars:3,consts:[[1,"row","mt-2","mx-0"],["class","col",4,"ngIf"],["class","col text-end",4,"ngIf"],[1,"col"],["size","small",3,"click"],["slot","icon-only","name","arrow-back-outline"],[1,"col","text-end"],["slot","icon-only","name","home-sharp"],["slot","icon-only",3,"name"]],template:function(a,l){1&a&&(o.TgZ(0,"div",0),o.YNc(1,i,3,0,"div",1),o.YNc(2,C,3,0,"div",2),o.YNc(3,y,3,1,"div",2),o.qZA()),2&a&&(o.xp6(1),o.Q6J("ngIf",l.backUrl),o.xp6(1),o.Q6J("ngIf",l.homeUrl),o.xp6(1),o.Q6J("ngIf",l.customButton))},dependencies:[g.O5,v.YG,v.gu],encapsulation:2}),t})()},1576:(b,p,r)=>{r.d(p,{Y:()=>v});var o=r(6895),c=r(4731),g=r(8256);let v=(()=>{class i{}return i.\u0275fac=function(y){return new(y||i)},i.\u0275mod=g.oAB({type:i}),i.\u0275inj=g.cJS({imports:[o.ez,c.Pc]}),i})()},6250:(b,p,r)=>{r.d(p,{T:()=>y});var o=r(655),c=r(7423),g=r(76);const v=(0,c.fo)("Camera",{web:()=>r.e(3954).then(r.bind(r,3954)).then(f=>new f.CameraWeb)});var i=r(1067),C=r(8256);let y=(()=>{class f{constructor(){this.takePicture=()=>(0,o.mG)(this,void 0,void 0,function*(){return yield v.getPhoto({quality:90,source:g.oK.Camera,resultType:g.dk.Uri})}),this.openGallery=()=>(0,o.mG)(this,void 0,void 0,function*(){return yield v.pickImages({quality:90,limit:1})}),this.convertBlobToBase64=s=>new Promise((a,l)=>{const u=new FileReader;u.onerror=l,u.onload=()=>{a(u.result)},u.readAsDataURL(s)})}saveLocalLogo(s){return(0,o.mG)(this,void 0,void 0,function*(){const a=yield this.readAsBase64(s);yield i.fy.writeFile({path:"logo.jpeg",data:a,directory:i.tP.Data})})}saveLocalAuditoryEvidence(s,a){return(0,o.mG)(this,void 0,void 0,function*(){const l=yield this.readAsBase64(s),u=`${a}-AUD${this.generateName()}`;return yield i.fy.writeFile({path:u,data:l,directory:i.tP.Data}),u})}saveLocalHelmetAuditoryEvidence(s,a){return(0,o.mG)(this,void 0,void 0,function*(){const l=yield this.readAsBase64(s),u=`${a}-HEL${this.generateName()}`;return yield i.fy.writeFile({path:u,data:l,directory:i.tP.Data}),u})}saveLocalBeltAuditoryEvidence(s,a){return(0,o.mG)(this,void 0,void 0,function*(){const l=`${a}-BEL${this.generateName()}`;return yield i.fy.writeFile({path:l,data:s,directory:i.tP.Data}),l})}saveLocalGeneralCountAuditoryEvidence(s,a){return(0,o.mG)(this,void 0,void 0,function*(){const l=`${a}-GCO${this.generateName()}`;return yield i.fy.writeFile({path:l,data:s,directory:i.tP.Data}),l})}saveLocalAnswerEvidence(s,a,l){return(0,o.mG)(this,void 0,void 0,function*(){const u=yield this.readAsBase64(s),x=`${a}-ANS${l}-${this.generateName()}`;return yield i.fy.writeFile({path:x,data:u,directory:i.tP.Data}),x})}getLocalAuditoryEvidence(s){return i.fy.readFile({path:s,encoding:i.ez.UTF8,directory:i.tP.Data})}getLocalAuditoryEvidenceUri(s){return i.fy.getUri({path:s,directory:i.tP.Data})}getLocalAnswerEvidence(s){return i.fy.readFile({path:s,encoding:i.ez.UTF8,directory:i.tP.Data})}getLocalAnswerEvidenceUri(s){return i.fy.getUri({path:s,directory:i.tP.Data})}removeLocalAuditoryEvidence(s){return i.fy.deleteFile({path:s,directory:i.tP.Data})}removeLocalAnswerEvidence(s){return i.fy.deleteFile({path:s,directory:i.tP.Data})}generateName(){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";let l="";for(let u=0;u<64;u++)l+=s.charAt(Math.floor(Math.random()*s.length));return`${l}.png`}getLocalLogo(){return i.fy.readFile({path:"logo.jpeg",encoding:i.ez.UTF8,directory:i.tP.Data})}getLocalLogoUri(){return i.fy.getUri({path:"logo.jpeg",directory:i.tP.Data})}readAsBase64(s){return(0,o.mG)(this,void 0,void 0,function*(){return yield this.convertBlobToBase64(s)})}onTakePicture(s){return(0,o.mG)(this,void 0,void 0,function*(){})}}return f.\u0275fac=function(s){return new(s||f)},f.\u0275prov=C.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"}),f})()},368:(b,p,r)=>{r.r(p),r.d(p,{GeneralCountAuditoryListPageModule:()=>W});var o=r(6895),c=r(4731),g=r(655),v=r(7423),i=r(1067),C=r(6408),y=r(313),f=r(7368),t=r(8256),s=r(2342),a=r(8246),l=r(3216),u=r(6250),x=r(2414),S=r(2424),T=r(1433),B=r(6280),F=r(6769);function G(h,L){if(1&h){const e=t.EpF();t.TgZ(0,"div",5)(1,"h4",6),t._uU(2,"Sin conteos"),t.qZA(),t.TgZ(3,"ion-button",7),t.NdJ("click",function(){t.CHM(e);const m=t.oxw();return t.KtG(m.onNewAuditory())}),t._uU(4,"Iniciar uno nuevo"),t.qZA()()}}function N(h,L){if(1&h&&(t.TgZ(0,"p"),t._uU(1),t.qZA()),2&h){const e=t.oxw().$implicit;t.xp6(1),t.hij("Fecha: ",e.date,"")}}function I(h,L){if(1&h){const e=t.EpF();t.TgZ(0,"ion-button",12),t.NdJ("click",function(){t.CHM(e);const m=t.oxw().$implicit,E=t.oxw();return t.KtG(E.presentActionSheetOptions(m))}),t._UZ(1,"ion-icon",13),t.qZA()}}function O(h,L){if(1&h){const e=t.EpF();t.TgZ(0,"ion-button",12),t.NdJ("click",function(){t.CHM(e);const m=t.oxw().$implicit,E=t.oxw();return t.KtG(E.onRemoteDetail(m.id))}),t._UZ(1,"ion-icon",14),t.qZA()}}function Z(h,L){if(1&h&&(t.TgZ(0,"ion-item",8)(1,"ion-label")(2,"h2",9),t._uU(3),t.qZA(),t.YNc(4,N,2,1,"p",10),t.TgZ(5,"p"),t._uU(6),t.qZA()(),t.YNc(7,I,2,0,"ion-button",11),t.YNc(8,O,2,0,"ion-button",11),t.qZA()),2&h){const e=L.$implicit,n=t.oxw();t.xp6(3),t.hij("T\xedtulo: ",e.title,""),t.xp6(1),t.Q6J("ngIf",e.date),t.xp6(2),t.hij("Estado: ",e.statusWord,""),t.xp6(1),t.Q6J("ngIf",!n.sendedList),t.xp6(1),t.Q6J("ngIf",n.sendedList)}}let M=(()=>{class h{constructor(e,n,m,E,_,D,d,P,A,U,Y){this.auditoryService=e,this.auditoryEvidenceService=n,this.helmetCollectionService=m,this.photoService=E,this.responseService=_,this.loadingService=D,this.router=d,this.confirmDialogService=P,this.actionSheetCtrl=A,this.route=U,this.platform=Y,this.auditories=[],this.sendedList=!1,this.loading=!1,this.customButton={click:()=>this.router.navigateByUrl(this.formUri),icon:"add"},this.backUri=(0,f.CE)(),this.formUri=(0,f.hF)("00"),this.platform.backButton.subscribeWithPriority(9999,()=>{this.router.navigateByUrl(this.backUri)})}ionViewWillEnter(){return(0,g.mG)(this,void 0,void 0,function*(){this.route.paramMap.subscribe({next:e=>{e.has("origin")?"remote"===e.get("origin")?this.fetchRemoteList():this.fetchLocalList():this.router.navigateByUrl(this.backUri)}}).unsubscribe()})}onGoingHome(){this.router.navigateByUrl(this.backUri)}onEdit(e){this.router.navigateByUrl((0,f.hF)(e))}onNewAuditory(){this.router.navigateByUrl((0,f.hF)("00"))}onUpload(e){this.confirmDialogService.presentAlert("Una vez enviado el conteo no se podr\xe1 modificar. \xbfDesea continuar?",()=>{this.loadingService.showLoading(),this.auditoryService.getUpdateData(e).subscribe({next:n=>{n!==y.W&&setTimeout(()=>{this.helmetCollectionService.getList(e).subscribe({next:m=>{if(m!==y.W){const E={title:n.values[0].title,description:n.values[0].description,close_note:n.values[0].close_note,date:n.values[0].date,time:n.values[0].time,lat:n.values[0].lat,lng:n.values[0].lng,status:n.values[0].status,creation_date:n.values[0].creation_date,update_date:n.values[0].update_date,external_id:n.values[0].id,user_id:n.values[0].user_id},_=m.values.map(d=>({helmet_auditory_id:d.helmet_auditory_id,count1:d.count1,count2:d.count2,count3:d.count3,count4:d.count4,count5:d.count5,count6:d.count6,count7:d.count7,count8:d.count8,count9:d.count9,count10:d.count10,count11:d.count11,count12:d.count12,creation_date:d.creation_date}));this.auditoryService.upload({auditory:E,counts:_}).subscribe({next:d=>{const P=d.data.id;this.auditoryService.updateExternalId(e,P).subscribe({next:A=>{A!==y.W&&setTimeout(()=>{this.uploadAuditoryPhotos(e,P)},20)}})},error:d=>this.responseService.onError(d,"No se pudo subir la auditor\xeda")})}}})},20)}})})}uploadAuditoryPhotos(e,n){this.auditoryEvidenceService.getEvidencesByAuditory(e).subscribe({next:m=>(0,g.mG)(this,void 0,void 0,function*(){m!==y.W&&this.uploadAuditoryEvidence(m.values,0,n).then(E=>{this.auditoryService.finalDelete(e).subscribe({next:_=>{_!==y.W&&(this.responseService.onSuccess("Auditor\xeda enviada exit\xf3samente"),setTimeout(()=>{this.fetchLocalList()},100))}})})})})}uploadAuditoryEvidence(e,n,m){return(0,g.mG)(this,void 0,void 0,function*(){return new Promise((_,D)=>(0,g.mG)(this,void 0,void 0,function*(){if(n===e.length)return _(!0);const d=yield this.photoService.getLocalAuditoryEvidenceUri(e[n].dir).then(A=>A.uri),P=yield fetch(v.dV.convertFileSrc(d)).then(A=>A.blob());this.auditoryEvidenceService.uploadImage(P,m,e[n].creation_date,e[n].dir).subscribe({next:()=>{this.photoService.removeLocalAuditoryEvidence(e[n].dir).then(()=>{this.auditoryEvidenceService.localRemove(e[n].dir).subscribe({next:A=>{A!==y.W&&this.uploadAuditoryEvidence(e,n+1,m).then(U=>_(U))}})})},error:A=>this.responseService.onError(A,"No se pudo subir la imagen")})}))})}onDelete(e){this.confirmDialogService.presentAlert("\xbfDesea eliminar el registro?",()=>{this.loadingService.showLoading(),this.auditoryService.deleteLocal(e).subscribe({next:n=>{n!==y.W&&(this.responseService.onSuccess("Registro eliminado"),setTimeout(()=>{this.fetchLocalList()},100))},error:n=>{this.responseService.onError(n,"No se pudo eliminar el registro")}})})}onDetail(e){this.router.navigateByUrl((0,f.H7)(e))}onRemoteDetail(e){this.router.navigateByUrl((0,f.Uz)(e))}onDownloadPdf(e,n){this.confirmDialogService.presentAlert("\xbfDesea descargar el conteo?",()=>{this.loadingService.showLoading(),this.auditoryService.downloadPdf(e).subscribe({next:m=>{const E=m,D=new RegExp(" ","g"),d=`${n.replace(D,"-")}.pdf`,P=new FileReader;P.readAsDataURL(E),P.onloadend=()=>(0,g.mG)(this,void 0,void 0,function*(){i.fy.writeFile({path:d,data:P.result,directory:i.tP.Cache}).then(()=>i.fy.getUri({directory:i.tP.Cache,path:d})).then(U=>C.m.share({title:d,text:d,url:U.uri})).then(()=>{this.loadingService.dismissLoading()}).catch(U=>this.responseService.onError(U,"No se pudo descargar la auditor\xeda"))})},error:m=>this.responseService.onError(m,"No se pudo descargar la auditor\xeda")})})}presentActionSheetOptions(e){return(0,g.mG)(this,void 0,void 0,function*(){const n=this.sendedList?[{text:"Ver Conteo",handler:()=>this.onRemoteDetail(e.id)},{text:"Descargar Conteo",handler:()=>this.onDownloadPdf(e.id,e.title)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]:e.countId?[{text:"Env\xedar Conteo",handler:()=>this.onUpload(e.id)},{text:"Actualizar Conteo",handler:()=>this.onDetail(e.id)},{text:"Actualizar catos generales",handler:()=>this.onEdit(e.id)},{text:"Eliminar Conteo",role:"destructive",handler:()=>this.onDelete(e.id)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]:[{text:"Actualizar Conteo",handler:()=>this.onDetail(e.id)},{text:"Actualizar datos generales",handler:()=>this.onEdit(e.id)},{text:"Eliminar Conteo",role:"destructive",handler:()=>this.onDelete(e.id)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}];yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:n})).present()})}fetchLocalList(){this.sendedList=!1,this.loadingService.showLoading(),this.loading=!0,this.auditoryService.getLocalList().subscribe({next:e=>{e!==y.W&&(this.auditories=e.map(n=>Object.assign(Object.assign({},n),{statusWord:1===n.status?"En progreso":"Terminada"})),this.loading=!1,this.loadingService.dismissLoading())},error:e=>{this.responseService.onError(e,"No se pudieron recuperar las auditor\xedas")}})}fetchRemoteList(){this.sendedList=!0,this.loadingService.showLoading(),this.auditoryService.getRemoteList().subscribe({next:e=>{this.sendedList=!0,this.auditories=e.data.map(n=>Object.assign(Object.assign({},n),{statusWord:"Enviado"})),this.loadingService.dismissLoading()},error:e=>{this.responseService.onError(e,"No se pudieron recuperar las auditor\xedas"),this.fetchLocalList()}})}}return h.\u0275fac=function(e){return new(e||h)(t.Y36(s.B),t.Y36(a.I),t.Y36(l.P),t.Y36(u.T),t.Y36(x.J),t.Y36(S.b),t.Y36(T.F0),t.Y36(B.D),t.Y36(c.BX),t.Y36(T.gz),t.Y36(c.t4))},h.\u0275cmp=t.Xpm({type:h,selectors:[["app-general-count-auditory-list"]],decls:15,vars:6,consts:[[3,"customButton","backUrl"],[1,"mx-2","mt-2"],["class","text-center",4,"ngIf"],["class","mt-2 txtInput",4,"ngFor","ngForOf"],["expand","full",3,"disabled","click"],[1,"text-center"],[1,"mt-2"],[3,"click"],[1,"mt-2","txtInput"],[1,"text-start"],[4,"ngIf"],["slot","end","size","small",3,"click",4,"ngIf"],["slot","end","size","small",3,"click"],["slot","icon-only","name","menu"],["slot","icon-only","name","eye"]],template:function(e,n){1&e&&(t.TgZ(0,"ion-content"),t._UZ(1,"app-header-buttons",0),t.TgZ(2,"div",1)(3,"h1"),t._uU(4,"Conteo General"),t.qZA(),t.YNc(5,G,5,0,"div",2),t.YNc(6,Z,9,5,"ion-item",3),t.qZA()(),t.TgZ(7,"ion-footer")(8,"ion-row")(9,"ion-col")(10,"ion-button",4),t.NdJ("click",function(){return n.fetchLocalList()}),t._uU(11,"SIN ENVIAR"),t.qZA()(),t.TgZ(12,"ion-col")(13,"ion-button",4),t.NdJ("click",function(){return n.fetchRemoteList()}),t._uU(14,"ENVIADAS"),t.qZA()()()()),2&e&&(t.xp6(1),t.Q6J("customButton",n.customButton)("backUrl",n.backUri),t.xp6(4),t.Q6J("ngIf",!n.loading&&0===n.auditories.length),t.xp6(1),t.Q6J("ngForOf",n.auditories),t.xp6(4),t.Q6J("disabled",!n.sendedList),t.xp6(3),t.Q6J("disabled",n.sendedList))},dependencies:[o.sg,o.O5,c.YG,c.wI,c.W2,c.fr,c.gu,c.Ie,c.Q$,c.Nd,F.$],encapsulation:2}),h})();var R=r(1576);const H=[{path:"",component:M}];let W=(()=>{class h{}return h.\u0275fac=function(e){return new(e||h)},h.\u0275mod=t.oAB({type:h}),h.\u0275inj=t.cJS({imports:[o.ez,c.Pc,T.Bz.forChild(H),R.Y]}),h})()}}]);