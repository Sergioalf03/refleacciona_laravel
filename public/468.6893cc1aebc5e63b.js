"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[468],{6769:(G,_,n)=>{n.d(_,{$:()=>g});var i=n(8256),a=n(1433),d=n(6895),c=n(4731);function p(l,t){if(1&l){const h=i.EpF();i.TgZ(0,"div",3)(1,"ion-button",4),i.NdJ("click",function(){i.CHM(h);const f=i.oxw();return i.KtG(f.onGoingBack())}),i._UZ(2,"ion-icon",5),i.qZA()()}}function A(l,t){if(1&l){const h=i.EpF();i.TgZ(0,"div",6)(1,"ion-button",4),i.NdJ("click",function(){i.CHM(h);const f=i.oxw();return i.KtG(f.onGoingHome())}),i._UZ(2,"ion-icon",7),i.qZA()()}}function b(l,t){if(1&l){const h=i.EpF();i.TgZ(0,"div",6)(1,"ion-button",4),i.NdJ("click",function(){i.CHM(h);const f=i.oxw();return i.KtG(f.customButton.click())}),i._UZ(2,"ion-icon",8),i.qZA()()}if(2&l){const h=i.oxw();i.xp6(2),i.Q6J("name",h.customButton.icon)}}let g=(()=>{class l{constructor(h){this.router=h}ngOnInit(){}onGoingHome(){this.router.navigateByUrl(this.homeUrl)}onGoingBack(){this.router.navigateByUrl(this.backUrl)}}return l.\u0275fac=function(h){return new(h||l)(i.Y36(a.F0))},l.\u0275cmp=i.Xpm({type:l,selectors:[["app-header-buttons"]],inputs:{homeUrl:"homeUrl",backUrl:"backUrl",customButton:"customButton"},decls:4,vars:3,consts:[[1,"row","mt-2","mx-0"],["class","col",4,"ngIf"],["class","col text-end",4,"ngIf"],[1,"col"],["size","small",3,"click"],["slot","icon-only","name","arrow-back-outline"],[1,"col","text-end"],["slot","icon-only","name","home-sharp"],["slot","icon-only",3,"name"]],template:function(h,S){1&h&&(i.TgZ(0,"div",0),i.YNc(1,p,3,0,"div",1),i.YNc(2,A,3,0,"div",2),i.YNc(3,b,3,1,"div",2),i.qZA()),2&h&&(i.xp6(1),i.Q6J("ngIf",S.backUrl),i.xp6(1),i.Q6J("ngIf",S.homeUrl),i.xp6(1),i.Q6J("ngIf",S.customButton))},dependencies:[d.O5,c.YG,c.gu],encapsulation:2}),l})()},1576:(G,_,n)=>{n.d(_,{Y:()=>c});var i=n(6895),a=n(4731),d=n(8256);let c=(()=>{class p{}return p.\u0275fac=function(b){return new(b||p)},p.\u0275mod=d.oAB({type:p}),p.\u0275inj=d.cJS({imports:[i.ez,a.Pc]}),p})()},468:(G,_,n)=>{n.r(_),n.d(_,{GeneralCountAuditoryFormPageModule:()=>W});var i=n(6895),a=n(433),d=n(4731),c=n(655),p=n(7423),A=n(6090),b=n(4464),g=n(313),l=n(7368),t=n(8256),h=n(2342),S=n(8246),f=n(1433),T=n(6572),E=n(2414),U=n(3916),Z=n(6250),P=n(6280),F=n(2424),B=n(1481),N=n(1006),M=n(6769);function H(s,y){if(1&s){const e=t.EpF();t.TgZ(0,"img",22),t.NdJ("click",function(){const r=t.CHM(e),u=r.$implicit,m=r.index,v=t.oxw(3);return t.KtG(v.onImgClicked(u.id,m))}),t.qZA()}if(2&s){const e=y.$implicit;t.Q6J("src",e.url,t.LSH)("ngStyle",e.expand)}}function J(s,y){if(1&s){const e=t.EpF();t.TgZ(0,"ion-button",23),t.NdJ("click",function(){t.CHM(e);const r=t.oxw(3);return t.KtG(r.onAddPhoto())}),t._UZ(1,"ion-icon",24),t.qZA()}}function L(s,y){if(1&s&&(t.TgZ(0,"ion-row")(1,"ion-col",19),t.YNc(2,H,1,2,"img",20),t.YNc(3,J,2,0,"ion-button",21),t.qZA()()),2&s){const e=t.oxw(2);t.xp6(1),t.Q6J("size",12),t.xp6(1),t.Q6J("ngForOf",e.ImageSrc),t.xp6(1),t.Q6J("ngIf",e.ImageSrc.length<10)}}function w(s,y){if(1&s){const e=t.EpF();t.TgZ(0,"form",4),t.NdJ("ngSubmit",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.onSubmit())}),t.TgZ(1,"div",5)(2,"h1"),t._uU(3),t.qZA(),t.TgZ(4,"ion-item",6)(5,"ion-label",7),t._uU(6,"*T\xedtulo"),t.qZA(),t._UZ(7,"ion-input",8),t.qZA(),t.TgZ(8,"ion-item",9)(9,"ion-label",7),t._uU(10,"*Fecha"),t.qZA(),t._UZ(11,"ion-input",10),t.qZA(),t.TgZ(12,"ion-item",9)(13,"ion-label",7),t._uU(14,"*Hora"),t.qZA(),t._UZ(15,"ion-input",11),t.qZA(),t.TgZ(16,"ion-item",12)(17,"ion-label",7),t._uU(18,"Descripci\xf3n"),t.qZA(),t._UZ(19,"ion-textarea",13),t.qZA(),t._UZ(20,"ion-input",14)(21,"ion-input",15),t.TgZ(22,"app-map",16),t.NdJ("centerEvent",function(r){t.CHM(e);const u=t.oxw();return t.KtG(u.onSetCoords(r))}),t.qZA(),t.TgZ(23,"ion-button",17),t.NdJ("click",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.onAddLocation())}),t._uU(24,"UBICACI\xd3N ACTUAL"),t.qZA(),t.YNc(25,L,4,3,"ion-row",18),t.qZA()()}if(2&s){const e=t.oxw();t.Q6J("formGroup",e.form),t.xp6(3),t.hij("",e.formActionText," Conteo General"),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("autoGrow",!0),t.xp6(6),t.Q6J("ngIf",e.ImageSrc)}}let D=(()=>{class s{constructor(e,o,r,u,m,v,C,I,x,k,Q,K){this.generalCountAuditoryService=e,this.generalCountAuditoryEvidenceService=o,this.router=r,this.route=u,this.validFormService=m,this.responseService=v,this.mapService=C,this.photoService=I,this.confirmDialogService=x,this.actionSheetCtrl=k,this.loadingService=Q,this.sanitization=K,this.formActionText="Nuevo",this.SubmitButtonText="Comenzar",this.auditoryId="0",this.backUrl=(0,l.CE)(),this.locationAdded=!1,this.hideMap=!0,this.ImageSrc=[]}initForm(){const e=new Date;e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.setSeconds(0);const o=e.toISOString().split("T"),r=o[1].split(".");this.form=new a.cw({title:new a.NI("",{validators:[a.kI.required]}),description:new a.NI(""),date:new a.NI(o[0],{validators:[a.kI.required,a.kI.minLength(1)]}),time:new a.NI(r[0],{validators:[a.kI.required,a.kI.minLength(1)]}),lat:new a.NI(""),lng:new a.NI("")})}createAuditory(e){return(0,c.mG)(this,void 0,void 0,function*(){this.generalCountAuditoryService.localSave(e).subscribe({next:o=>{o!==g.W&&this.generalCountAuditoryService.getLastSavedId().subscribe({next:r=>(0,c.mG)(this,void 0,void 0,function*(){if(r!==g.W){this.hideMap=!0,this.auditoryId=r.values[0].id;let u=0;this.ImageSrc.length>0?this.ImageSrc.forEach((m,v)=>(0,c.mG)(this,void 0,void 0,function*(){setTimeout(()=>(0,c.mG)(this,void 0,void 0,function*(){const C=yield fetch(m.base64).then(I=>I.blob());this.photoService.saveLocalGeneralCountAuditoryEvidence(C,this.auditoryId).then(I=>{this.generalCountAuditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:I}).subscribe({next:x=>(0,c.mG)(this,void 0,void 0,function*(){x!==g.W&&(u++,u===this.ImageSrc.length&&this.responseService.onSuccessAndRedirect((0,l.H7)(this.auditoryId),"Levantmiento guardado"))}),error:x=>{this.responseService.onError(x,"No se pudo guardar una imagen")}})}).catch()}),100*v)})):this.responseService.onSuccessAndRedirect((0,l.H7)(this.auditoryId),"Levantmiento guardado")}})})},error:o=>{this.responseService.onError(o,"No se pudo guardar")}})})}updateAuditory(e){this.generalCountAuditoryService.updateLocal(this.auditoryId,e).subscribe({next:o=>{o!==g.W&&(this.hideMap=!0,this.responseService.onSuccessAndRedirect((0,l.nH)("local"),"Registro actualizado"))},error:o=>{this.responseService.onError(o,"No se pudo actualizar")}})}setAuditory(e){this.backUrl=(0,l.nH)("local"),this.form.setValue({title:e.title,description:e.description,date:e.date,time:e.time,lat:e.lat,lng:e.lng}),this.generalCountAuditoryEvidenceService.getEvidencesByAuditory(this.auditoryId).subscribe({next:o=>{o!==g.W&&((0,b.n$)("hybrid")?o.values.forEach(r=>(0,c.mG)(this,void 0,void 0,function*(){this.photoService.getLocalAuditoryEvidenceUri(r.dir).then(u=>{this.ImageSrc.push({id:r.dir,url:p.dV.convertFileSrc(u.uri),base64:"",expand:{width:"25%"}})})})):o.values.forEach(r=>(0,c.mG)(this,void 0,void 0,function*(){this.photoService.getLocalAuditoryEvidence(r.dir).then(u=>{const m="data:image/png;base64,"+u.data;this.ImageSrc.push({id:r.dir,url:m,base64:m,expand:{width:"25%"}})})})))}}),setTimeout(()=>{this.mapService.setCenter(e.lat,e.lng),this.loadingService.dismissLoading()},1e3)}ngOnInit(){this.hideMap=!0}ionViewWillEnter(){this.initForm(),this.route.paramMap.subscribe({next:e=>{let o=e.get("id")||"0";"00"===o&&(this.backUrl=(0,l.nH)("local"),o="0"),"0"!==o&&(this.loadingService.showLoading(),this.auditoryId=o,this.formActionText="Actualizando",this.SubmitButtonText="Guardar",this.generalCountAuditoryService.getLocalForm(this.auditoryId).subscribe({next:r=>{r!==g.W&&this.setAuditory(r.values[0])},error:r=>{this.responseService.onError(r,"No se pudieron recuperar los datos")}}))}}).unsubscribe()}ionViewWillLeave(){this.formActionText="Nueva",this.SubmitButtonText="Comenzar",this.auditoryId="0",this.locationAdded=!1,this.form=new a.cw({}),this.ImageSrc=[],this.hideMap=!0}onSubmit(){this.validFormService.isValid(this.form,[])&&this.confirmDialogService.presentAlert("\xbfDesea guardar los cambios?",()=>{this.loadingService.showLoading(),this.mapService.setCenter(0,0);const e={title:this.form.controls.title.value,description:this.form.controls.description.value,date:this.form.controls.date.value,time:this.form.controls.time.value,lat:this.form.controls.lat.value,lng:this.form.controls.lng.value};"0"===this.auditoryId?this.createAuditory(e):this.updateAuditory(e)})}onAddLocation(){return(0,c.mG)(this,void 0,void 0,function*(){this.hideMap=!1;const e=yield A.b.getCurrentPosition({enableHighAccuracy:!0});this.mapService.setCenter(e.coords.latitude,e.coords.longitude)})}onCancel(){this.router.navigateByUrl(this.backUrl)}onAddPhoto(){return(0,c.mG)(this,void 0,void 0,function*(){yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:[{text:"C\xe1mara",handler:()=>this.fromCamera()},{text:"Galer\xeda",handler:()=>this.fromGallery()},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]})).present()})}fromGallery(){this.photoService.openGallery().then(e=>(0,c.mG)(this,void 0,void 0,function*(){if("0"===this.auditoryId)for(let o=0;o<e.photos.length;o++)this.ImageSrc.push({id:"",url:this.sanitization.bypassSecurityTrustUrl(e.photos[o].webPath),base64:e.photos[o].webPath,expand:{width:"25%"}});else for(let o=0;o<e.photos.length;o++){const r=e.photos[o].webPath,u=yield fetch(r).then(m=>m.blob());this.photoService.saveLocalGeneralCountAuditoryEvidence(u,this.auditoryId).then(m=>{m!==g.W&&this.generalCountAuditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:m}).subscribe({next:v=>(0,c.mG)(this,void 0,void 0,function*(){v!==g.W&&this.generalCountAuditoryEvidenceService.getLastInsertedDir().subscribe({next:C=>(0,c.mG)(this,void 0,void 0,function*(){C!==g.W&&this.ImageSrc.push({id:C.values[0].dir,url:this.sanitization.bypassSecurityTrustUrl(r),base64:r,expand:{width:"25%"}})})})}),error:v=>{this.responseService.onError(v,"No se pudo guardar una imagen")}})})}}))}fromCamera(){this.photoService.takePicture().then(e=>(0,c.mG)(this,void 0,void 0,function*(){if("0"===this.auditoryId)this.ImageSrc.push({id:"",url:this.sanitization.bypassSecurityTrustUrl(e.webPath||""),base64:e.webPath||"",expand:{width:"25%"}});else{const o=e.webPath||"",r=yield fetch(o).then(u=>u.blob());this.photoService.saveLocalGeneralCountAuditoryEvidence(r,this.auditoryId).then(u=>{u!==g.W&&this.generalCountAuditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:u}).subscribe({next:m=>(0,c.mG)(this,void 0,void 0,function*(){m!==g.W&&this.generalCountAuditoryEvidenceService.getLastInsertedDir().subscribe({next:v=>(0,c.mG)(this,void 0,void 0,function*(){v!==g.W&&this.ImageSrc.push({id:v.values[0].dir,url:this.sanitization.bypassSecurityTrustUrl(o),base64:o,expand:{width:"25%"}})})})}),error:m=>{this.responseService.onError(m,"No se pudo guardar una imagen")}})})}}))}onSetCoords(e){this.form.controls.lat.setValue(e.lat),this.form.controls.lng.setValue(e.lng)}onImgClicked(e,o){return(0,c.mG)(this,void 0,void 0,function*(){yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:[{text:"Cambiar tama\xf1o",handler:()=>this.onChangeSize(o)},{text:"Eliminar Foto",role:"destructive",handler:()=>this.onRemove(e,o)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]})).present()})}onChangeSize(e){this.ImageSrc[e].expand="25%"===this.ImageSrc[e].expand.width?{width:"100%"}:{width:"25%"}}onRemove(e,o){this.confirmDialogService.presentAlert("\xbfDesea eliminar la imagen?",()=>{e?this.generalCountAuditoryEvidenceService.localRemove(e).subscribe({next:()=>{this.photoService.removeLocalAuditoryEvidence(e).then(()=>this.ImageSrc.splice(o,1))}}):this.ImageSrc.splice(o,1)})}}return s.\u0275fac=function(e){return new(e||s)(t.Y36(h.B),t.Y36(S.I),t.Y36(f.F0),t.Y36(f.gz),t.Y36(T.i),t.Y36(E.J),t.Y36(U.S),t.Y36(Z.T),t.Y36(P.D),t.Y36(d.BX),t.Y36(F.b),t.Y36(B.H7))},s.\u0275cmp=t.Xpm({type:s,selectors:[["app-general-count-auditory-form"]],decls:11,vars:3,consts:[["homeUrl","/home",3,"backUrl"],[3,"formGroup","ngSubmit",4,"ngIf"],["color","danger","expand","full",3,"click"],["expand","full","type","button",3,"click"],[3,"formGroup","ngSubmit"],[1,"mx-2","mt-4"],[1,"mt-4","txtInput"],["position","floating"],["formControlName","title","type","text","placeholder","Escriba un t\xedtulo",3,"clearInput"],[1,"mt-2","txtInput"],["formControlName","date","type","date","placeholder","Escriba el sentido",3,"clearInput"],["formControlName","time","type","time","placeholder","Escriba el sentido",3,"clearInput"],[1,"mt-2","txtInput","mb-2"],["formControlName","description","type","text","rows","3","placeholder","Agregue una descripci\xf3n",3,"autoGrow"],["formControlName","lat","type","hidden","hidden",""],["formControlName","lng","type","hidden","hidden",""],[3,"centerEvent"],["expand","full","color","light",1,"mt-3",3,"click"],[4,"ngIf"],[3,"size"],[3,"src","ngStyle","click",4,"ngFor","ngForOf"],["class","btn-right","fill","clear","size","large",3,"click",4,"ngIf"],[3,"src","ngStyle","click"],["fill","clear","size","large",1,"btn-right",3,"click"],["slot","icon-only","name","image-outline",1,"icon-color"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-content"),t._UZ(1,"app-header-buttons",0),t.YNc(2,w,26,7,"form",1),t.qZA(),t.TgZ(3,"ion-footer")(4,"ion-row")(5,"ion-col")(6,"ion-button",2),t.NdJ("click",function(){return o.onCancel()}),t._uU(7," CANCELAR "),t.qZA()(),t.TgZ(8,"ion-col")(9,"ion-button",3),t.NdJ("click",function(){return o.onSubmit()}),t._uU(10),t.qZA()()()()),2&e&&(t.xp6(1),t.Q6J("backUrl",o.backUrl),t.xp6(1),t.Q6J("ngIf",o.form),t.xp6(8),t.hij(" ",o.SubmitButtonText," "))},dependencies:[i.sg,i.O5,i.PC,a._Y,a.JJ,a.JL,a.sg,a.u,d.YG,d.wI,d.W2,d.fr,d.gu,d.pK,d.Ie,d.Q$,d.Nd,d.g2,d.j9,N.G,M.$],encapsulation:2}),s})();var Y=n(3375),O=n(1576);const z=[{path:"",component:D}];let W=(()=>{class s{}return s.\u0275fac=function(e){return new(e||s)},s.\u0275mod=t.oAB({type:s}),s.\u0275inj=t.cJS({imports:[i.ez,a.UX,d.Pc,f.Bz.forChild(z),Y.R,O.Y]}),s})()}}]);