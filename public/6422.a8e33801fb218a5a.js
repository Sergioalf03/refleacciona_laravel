"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6422],{6769:(T,b,n)=>{n.d(b,{$:()=>h});var o=n(8256),s=n(1433),d=n(6895),c=n(4731);function g(v,t){if(1&v){const m=o.EpF();o.TgZ(0,"div",3)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(m);const S=o.oxw();return o.KtG(S.onGoingBack())}),o._UZ(2,"ion-icon",5),o.qZA()()}}function f(v,t){if(1&v){const m=o.EpF();o.TgZ(0,"div",6)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(m);const S=o.oxw();return o.KtG(S.onGoingHome())}),o._UZ(2,"ion-icon",7),o.qZA()()}}function x(v,t){if(1&v){const m=o.EpF();o.TgZ(0,"div",6)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(m);const S=o.oxw();return o.KtG(S.customButton.click())}),o._UZ(2,"ion-icon",8),o.qZA()()}if(2&v){const m=o.oxw();o.xp6(2),o.Q6J("name",m.customButton.icon)}}let h=(()=>{class v{constructor(m){this.router=m}ngOnInit(){}onGoingHome(){this.router.navigateByUrl(this.homeUrl)}onGoingBack(){this.router.navigateByUrl(this.backUrl)}}return v.\u0275fac=function(m){return new(m||v)(o.Y36(s.F0))},v.\u0275cmp=o.Xpm({type:v,selectors:[["app-header-buttons"]],inputs:{homeUrl:"homeUrl",backUrl:"backUrl",customButton:"customButton"},decls:4,vars:3,consts:[[1,"row","mt-2","mx-0"],["class","col",4,"ngIf"],["class","col text-end",4,"ngIf"],[1,"col"],["size","small",3,"click"],["slot","icon-only","name","arrow-back-outline"],[1,"col","text-end"],["slot","icon-only","name","home-sharp"],["slot","icon-only",3,"name"]],template:function(m,_){1&m&&(o.TgZ(0,"div",0),o.YNc(1,g,3,0,"div",1),o.YNc(2,f,3,0,"div",2),o.YNc(3,x,3,1,"div",2),o.qZA()),2&m&&(o.xp6(1),o.Q6J("ngIf",_.backUrl),o.xp6(1),o.Q6J("ngIf",_.homeUrl),o.xp6(1),o.Q6J("ngIf",_.customButton))},dependencies:[d.O5,c.YG,c.gu],encapsulation:2}),v})()},1576:(T,b,n)=>{n.d(b,{Y:()=>c});var o=n(6895),s=n(4731),d=n(8256);let c=(()=>{class g{}return g.\u0275fac=function(x){return new(x||g)},g.\u0275mod=d.oAB({type:g}),g.\u0275inj=d.cJS({imports:[o.ez,s.Pc]}),g})()},6422:(T,b,n)=>{n.r(b),n.d(b,{HelmetInitialFormPageModule:()=>W});var o=n(6895),s=n(433),d=n(4731),c=n(655),g=n(4464),f=n(7368),x=n(6090),h=n(313),v=n(7423),t=n(8256),m=n(1005),_=n(2740),S=n(1433),E=n(6572),U=n(2414),Z=n(3916),H=n(6250),F=n(6280),P=n(2424),G=n(1481),M=n(1006),B=n(6769);function N(a,I){if(1&a){const e=t.EpF();t.TgZ(0,"img",22),t.NdJ("click",function(){const r=t.CHM(e),l=r.$implicit,u=r.index,p=t.oxw(3);return t.KtG(p.onImgClicked(l.id,u))}),t.qZA()}if(2&a){const e=I.$implicit;t.Q6J("src",e.url,t.LSH)("ngStyle",e.expand)}}function J(a,I){if(1&a){const e=t.EpF();t.TgZ(0,"ion-button",23),t.NdJ("click",function(){t.CHM(e);const r=t.oxw(3);return t.KtG(r.onAddPhoto())}),t._UZ(1,"ion-icon",24),t.qZA()}}function L(a,I){if(1&a&&(t.TgZ(0,"ion-row")(1,"ion-col",19),t.YNc(2,N,1,2,"img",20),t.YNc(3,J,2,0,"ion-button",21),t.qZA()()),2&a){const e=t.oxw(2);t.xp6(1),t.Q6J("size",12),t.xp6(1),t.Q6J("ngForOf",e.ImageSrc),t.xp6(1),t.Q6J("ngIf",e.ImageSrc.length<10)}}function w(a,I){if(1&a){const e=t.EpF();t.TgZ(0,"form",4),t.NdJ("ngSubmit",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.onSubmit())}),t.TgZ(1,"div",5)(2,"h1"),t._uU(3),t.qZA(),t.TgZ(4,"ion-item",6)(5,"ion-label",7),t._uU(6,"*T\xedtulo"),t.qZA(),t._UZ(7,"ion-input",8),t.qZA(),t.TgZ(8,"ion-item",9)(9,"ion-label",7),t._uU(10,"*Fecha"),t.qZA(),t._UZ(11,"ion-input",10),t.qZA(),t.TgZ(12,"ion-item",9)(13,"ion-label",7),t._uU(14,"*Hora"),t.qZA(),t._UZ(15,"ion-input",11),t.qZA(),t.TgZ(16,"ion-item",12)(17,"ion-label",7),t._uU(18,"Descripci\xf3n"),t.qZA(),t._UZ(19,"ion-textarea",13),t.qZA(),t._UZ(20,"ion-input",14)(21,"ion-input",15),t.TgZ(22,"app-map",16),t.NdJ("centerEvent",function(r){t.CHM(e);const l=t.oxw();return t.KtG(l.onSetCoords(r))}),t.qZA(),t.TgZ(23,"ion-button",17),t.NdJ("click",function(){t.CHM(e);const r=t.oxw();return t.KtG(r.onAddLocation())}),t._uU(24,"UBICACI\xd3N ACTUAL"),t.qZA(),t.YNc(25,L,4,3,"ion-row",18),t.qZA()()}if(2&a){const e=t.oxw();t.Q6J("formGroup",e.form),t.xp6(3),t.hij("",e.formActionText," Uso de Casco"),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("autoGrow",!0),t.xp6(6),t.Q6J("ngIf",e.ImageSrc)}}let D=(()=>{class a{constructor(e,i,r,l,u,p,y,A,C,k,Q,R){this.helmetAuditoryService=e,this.helmetAuditoryEvidenceService=i,this.router=r,this.route=l,this.validFormService=u,this.responseService=p,this.mapService=y,this.photoService=A,this.confirmDialogService=C,this.actionSheetCtrl=k,this.loadingService=Q,this.sanitization=R,this.formActionText="Nuevo",this.SubmitButtonText="Comenzar",this.auditoryId="0",this.backUrl=(0,f.CE)(),this.locationAdded=!1,this.hideMap=!0,this.ImageSrc=[]}initForm(){const e=new Date;e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.setSeconds(0);const i=e.toISOString().split("T"),r=i[1].split(".");this.form=new s.cw({title:new s.NI("",{validators:[s.kI.required]}),description:new s.NI(""),date:new s.NI(i[0],{validators:[s.kI.required,s.kI.minLength(1)]}),time:new s.NI(r[0],{validators:[s.kI.required,s.kI.minLength(1)]}),lat:new s.NI(""),lng:new s.NI("")})}createAuditory(e){return(0,c.mG)(this,void 0,void 0,function*(){this.helmetAuditoryService.localSave(e).subscribe({next:i=>{i!==h.W&&this.helmetAuditoryService.getLastSavedId().subscribe({next:r=>(0,c.mG)(this,void 0,void 0,function*(){if(r!==h.W){this.hideMap=!0,this.auditoryId=r.values[0].id;let l=0;this.ImageSrc.length>0?this.ImageSrc.forEach((u,p)=>(0,c.mG)(this,void 0,void 0,function*(){setTimeout(()=>(0,c.mG)(this,void 0,void 0,function*(){const y=yield fetch(u.base64).then(A=>A.blob());this.photoService.saveLocalHelmetAuditoryEvidence(y,this.auditoryId).then(A=>{this.helmetAuditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:A}).subscribe({next:C=>(0,c.mG)(this,void 0,void 0,function*(){C!==h.W&&(l++,l===this.ImageSrc.length&&this.responseService.onSuccessAndRedirect((0,f.F$)(this.auditoryId),"Levantmiento guardado"))}),error:C=>{this.responseService.onError(C,"No se pudo guardar una imagen")}})}).catch()}),100*p)})):this.responseService.onSuccessAndRedirect((0,f.F$)(this.auditoryId),"Levantmiento guardado")}})})},error:i=>{this.responseService.onError(i,"No se pudo guardar")}})})}updateAuditory(e){this.helmetAuditoryService.updateLocal(this.auditoryId,e).subscribe({next:i=>{i!==h.W&&(this.hideMap=!0,this.responseService.onSuccessAndRedirect((0,f.Ms)("local"),"Registro actualizado"))},error:i=>{this.responseService.onError(i,"No se pudo actualizar")}})}setAuditory(e){this.backUrl=(0,f.Ms)("local"),this.form.setValue({title:e.title,description:e.description,date:e.date,time:e.time,lat:e.lat,lng:e.lng}),this.helmetAuditoryEvidenceService.getEvidencesByAuditory(this.auditoryId).subscribe({next:i=>{i!==h.W&&((0,g.n$)("hybrid")?i.values.forEach(r=>(0,c.mG)(this,void 0,void 0,function*(){this.photoService.getLocalAuditoryEvidenceUri(r.dir).then(l=>{this.ImageSrc.push({id:r.dir,url:v.dV.convertFileSrc(l.uri),base64:"",expand:{width:"25%"}})})})):i.values.forEach(r=>(0,c.mG)(this,void 0,void 0,function*(){this.photoService.getLocalAuditoryEvidence(r.dir).then(l=>{const u="data:image/png;base64,"+l.data;this.ImageSrc.push({id:r.dir,url:u,base64:u,expand:{width:"25%"}})})})))}}),setTimeout(()=>{this.mapService.setCenter(e.lat,e.lng),this.loadingService.dismissLoading()},1e3)}ngOnInit(){this.hideMap=!0}ionViewWillEnter(){this.initForm(),this.route.paramMap.subscribe({next:e=>{let i=e.get("id")||"0";"00"===i&&(this.backUrl=(0,f.Ms)("local"),i="0"),"0"!==i&&(this.loadingService.showLoading(),this.auditoryId=i,this.formActionText="Actualizando",this.SubmitButtonText="Guardar",this.helmetAuditoryService.getLocalForm(this.auditoryId).subscribe({next:r=>{r!==h.W&&this.setAuditory(r.values[0])},error:r=>{this.responseService.onError(r,"No se pudieron recuperar los datos")}}))}}).unsubscribe()}ionViewWillLeave(){this.formActionText="Nueva",this.SubmitButtonText="Comenzar",this.auditoryId="0",this.locationAdded=!1,this.form=new s.cw({}),this.ImageSrc=[],this.hideMap=!0}onSubmit(){this.validFormService.isValid(this.form,[])&&this.confirmDialogService.presentAlert("\xbfDesea guardar los cambios?",()=>{this.loadingService.showLoading(),this.mapService.setCenter(0,0);const e={title:this.form.controls.title.value,description:this.form.controls.description.value,date:this.form.controls.date.value,time:this.form.controls.time.value,lat:this.form.controls.lat.value,lng:this.form.controls.lng.value};"0"===this.auditoryId?this.createAuditory(e):this.updateAuditory(e)})}onAddLocation(){return(0,c.mG)(this,void 0,void 0,function*(){this.hideMap=!1;const e=yield x.b.getCurrentPosition({enableHighAccuracy:!0});this.mapService.setCenter(e.coords.latitude,e.coords.longitude)})}onCancel(){this.router.navigateByUrl(this.backUrl)}onAddPhoto(){return(0,c.mG)(this,void 0,void 0,function*(){yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:[{text:"C\xe1mara",handler:()=>this.fromCamera()},{text:"Galer\xeda",handler:()=>this.fromGallery()},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]})).present()})}fromGallery(){this.photoService.openGallery().then(e=>(0,c.mG)(this,void 0,void 0,function*(){if("0"===this.auditoryId)for(let i=0;i<e.photos.length;i++)this.ImageSrc.push({id:"",url:this.sanitization.bypassSecurityTrustUrl(e.photos[i].webPath),base64:e.photos[i].webPath,expand:{width:"25%"}});else for(let i=0;i<e.photos.length;i++){const r=e.photos[i].webPath,l=yield fetch(r).then(u=>u.blob());this.photoService.saveLocalHelmetAuditoryEvidence(l,this.auditoryId).then(u=>{u!==h.W&&this.helmetAuditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:u}).subscribe({next:p=>(0,c.mG)(this,void 0,void 0,function*(){p!==h.W&&this.helmetAuditoryEvidenceService.getLastInsertedDir().subscribe({next:y=>(0,c.mG)(this,void 0,void 0,function*(){y!==h.W&&this.ImageSrc.push({id:y.values[0].dir,url:this.sanitization.bypassSecurityTrustUrl(r),base64:r,expand:{width:"25%"}})})})}),error:p=>{this.responseService.onError(p,"No se pudo guardar una imagen")}})})}}))}fromCamera(){this.photoService.takePicture().then(e=>(0,c.mG)(this,void 0,void 0,function*(){if("0"===this.auditoryId)this.ImageSrc.push({id:"",url:this.sanitization.bypassSecurityTrustUrl(e.webPath||""),base64:e.webPath||"",expand:{width:"25%"}});else{const i=e.webPath||"",r=yield fetch(i).then(l=>l.blob());this.photoService.saveLocalHelmetAuditoryEvidence(r,this.auditoryId).then(l=>{l!==h.W&&this.helmetAuditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:l}).subscribe({next:u=>(0,c.mG)(this,void 0,void 0,function*(){u!==h.W&&this.helmetAuditoryEvidenceService.getLastInsertedDir().subscribe({next:p=>(0,c.mG)(this,void 0,void 0,function*(){p!==h.W&&this.ImageSrc.push({id:p.values[0].dir,url:this.sanitization.bypassSecurityTrustUrl(i),base64:i,expand:{width:"25%"}})})})}),error:u=>{this.responseService.onError(u,"No se pudo guardar una imagen")}})})}}))}onSetCoords(e){this.form.controls.lat.setValue(e.lat),this.form.controls.lng.setValue(e.lng)}onImgClicked(e,i){return(0,c.mG)(this,void 0,void 0,function*(){yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:[{text:"Cambiar tama\xf1o",handler:()=>this.onChangeSize(i)},{text:"Eliminar Foto",role:"destructive",handler:()=>this.onRemove(e,i)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]})).present()})}onChangeSize(e){this.ImageSrc[e].expand="25%"===this.ImageSrc[e].expand.width?{width:"100%"}:{width:"25%"}}onRemove(e,i){this.confirmDialogService.presentAlert("\xbfDesea eliminar la imagen?",()=>{e?this.helmetAuditoryEvidenceService.localRemove(e).subscribe({next:()=>{this.photoService.removeLocalAuditoryEvidence(e).then(()=>this.ImageSrc.splice(i,1))}}):this.ImageSrc.splice(i,1)})}}return a.\u0275fac=function(e){return new(e||a)(t.Y36(m.G),t.Y36(_.R),t.Y36(S.F0),t.Y36(S.gz),t.Y36(E.i),t.Y36(U.J),t.Y36(Z.S),t.Y36(H.T),t.Y36(F.D),t.Y36(d.BX),t.Y36(P.b),t.Y36(G.H7))},a.\u0275cmp=t.Xpm({type:a,selectors:[["app-helmet-initial-form"]],decls:11,vars:3,consts:[["homeUrl","/home",3,"backUrl"],[3,"formGroup","ngSubmit",4,"ngIf"],["color","danger","expand","full",3,"click"],["expand","full","type","submit",3,"click"],[3,"formGroup","ngSubmit"],[1,"mx-2","mt-4"],[1,"mt-4","txtInput"],["position","floating"],["formControlName","title","type","text","placeholder","Escriba un t\xedtulo",3,"clearInput"],[1,"mt-2","txtInput"],["formControlName","date","type","date","placeholder","Escriba el sentido",3,"clearInput"],["formControlName","time","type","time","placeholder","Escriba el sentido",3,"clearInput"],[1,"mt-2","txtInput","mb-2"],["formControlName","description","type","text","rows","3","placeholder","Agregue una descripci\xf3n",3,"autoGrow"],["formControlName","lat","type","hidden","hidden",""],["formControlName","lng","type","hidden","hidden",""],[3,"centerEvent"],["expand","full","color","light",1,"mt-3",3,"click"],[4,"ngIf"],[3,"size"],[3,"src","ngStyle","click",4,"ngFor","ngForOf"],["class","btn-right","fill","clear","size","large",3,"click",4,"ngIf"],[3,"src","ngStyle","click"],["fill","clear","size","large",1,"btn-right",3,"click"],["slot","icon-only","name","image-outline",1,"icon-color"]],template:function(e,i){1&e&&(t.TgZ(0,"ion-content"),t._UZ(1,"app-header-buttons",0),t.YNc(2,w,26,7,"form",1),t.qZA(),t.TgZ(3,"ion-footer")(4,"ion-row")(5,"ion-col")(6,"ion-button",2),t.NdJ("click",function(){return i.onCancel()}),t._uU(7," CANCELAR "),t.qZA()(),t.TgZ(8,"ion-col")(9,"ion-button",3),t.NdJ("click",function(){return i.onSubmit()}),t._uU(10),t.qZA()()()()),2&e&&(t.xp6(1),t.Q6J("backUrl",i.backUrl),t.xp6(1),t.Q6J("ngIf",i.form),t.xp6(8),t.hij(" ",i.SubmitButtonText," "))},dependencies:[o.sg,o.O5,o.PC,s._Y,s.JJ,s.JL,s.sg,s.u,d.YG,d.wI,d.W2,d.fr,d.gu,d.pK,d.Ie,d.Q$,d.Nd,d.g2,d.j9,M.G,B.$],encapsulation:2}),a})();var Y=n(3375),O=n(1576);const z=[{path:"",component:D}];let W=(()=>{class a{}return a.\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.oAB({type:a}),a.\u0275inj=t.cJS({imports:[o.ez,s.u5,s.UX,d.Pc,S.Bz.forChild(z),Y.R,O.Y]}),a})()}}]);