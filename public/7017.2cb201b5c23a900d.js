"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7017],{7017:(z,S,n)=>{n.r(S),n.d(S,{AuditoryListPageModule:()=>R});var b=n(6895),u=n(4731),m=n(655),L=n(7423),g=n(7368),h=n(313),e=n(8256),E=n(1032),y=n(6118),x=n(2628),w=n(1229),_=n(6250),U=n(2414),P=n(2424),A=n(1433),T=n(6280),D=n(6769);function Z(s,v){if(1&s){const t=e.EpF();e.TgZ(0,"div",5)(1,"h4",6),e._uU(2,"Sin auditor\xedas"),e.qZA(),e.TgZ(3,"ion-button",7),e.NdJ("click",function(){e.CHM(t);const o=e.oxw();return e.KtG(o.onNewAuditory())}),e._uU(4,"Iniciar una nueva"),e.qZA()()}}function B(s,v){if(1&s&&(e.TgZ(0,"p"),e._uU(1),e.qZA()),2&s){const t=e.oxw().$implicit;e.xp6(1),e.hij("Fecha: ",t.date,"")}}function N(s,v){if(1&s){const t=e.EpF();e.TgZ(0,"ion-button",12),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit,c=e.oxw();return e.KtG(c.presentActionSheetOptions(o))}),e._UZ(1,"ion-icon",13),e.qZA()}}function I(s,v){if(1&s){const t=e.EpF();e.TgZ(0,"ion-button",12),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit,c=e.oxw();return e.KtG(c.onRemoteDetail(o.id))}),e._UZ(1,"ion-icon",14),e.qZA()}}function Y(s,v){if(1&s&&(e.TgZ(0,"ion-item",8)(1,"ion-label")(2,"h2",9),e._uU(3),e.qZA(),e.YNc(4,B,2,1,"p",10),e.TgZ(5,"p"),e._uU(6),e.qZA()(),e.YNc(7,N,2,0,"ion-button",11),e.YNc(8,I,2,0,"ion-button",11),e.qZA()),2&s){const t=v.$implicit,i=e.oxw();e.xp6(3),e.hij("T\xedtulo: ",t.title,""),e.xp6(1),e.Q6J("ngIf",t.date),e.xp6(2),e.hij("Estado: ",t.statusWord,""),e.xp6(1),e.Q6J("ngIf",!i.sendedList),e.xp6(1),e.Q6J("ngIf",i.sendedList)}}let W=(()=>{class s{constructor(t,i,o,c,d,l,a,p,r,f,O,G){this.auditoryService=t,this.auditoryEvidenceService=i,this.answerService=o,this.answerEvidenceService=c,this.photoService=d,this.responseService=l,this.loadingService=a,this.router=p,this.confirmDialogService=r,this.actionSheetCtrl=f,this.route=O,this.platform=G,this.auditories=[],this.sendedList=!1,this.loading=!1,this.customButton={click:()=>this.router.navigateByUrl(this.formUri),icon:"add"},this.backUri=(0,g.CE)(),this.formUri=(0,g.bD)("00"),this.platform.backButton.subscribeWithPriority(9999,()=>{this.router.navigateByUrl(this.backUri)})}ngOnInit(){this.route.paramMap.subscribe({next:t=>{t.has("origin")?"remote"===t.get("origin")?this.fetchRemoteList():this.fetchLocalList():this.router.navigateByUrl(this.backUri)}}).unsubscribe()}ionViewWillEnter(){return(0,m.mG)(this,void 0,void 0,function*(){})}onGoingHome(){this.router.navigateByUrl(this.backUri)}onEdit(t){this.router.navigateByUrl((0,g.bD)(t))}onEditAnswers(t,i){this.router.navigateByUrl((0,g.vk)("1",t,`${i}`))}onNewAuditory(){this.router.navigateByUrl((0,g.bD)("00"))}onUpload(t){this.confirmDialogService.presentAlert("Una vez enviada la auditor\xeda no se podr\xe1 modificar. \xbfDesea continuar?",()=>{this.loadingService.showLoading(),this.auditoryService.getUpdateData(t).subscribe({next:i=>{i!==h.W&&setTimeout(()=>{this.answerService.getAnswersBySectionByAuditory(t).subscribe({next:o=>{if(o!==h.W){const c={title:i.values[0].title,description:i.values[0].description,close_note:i.values[0].close_note,date:i.values[0].date,time:i.values[0].time,lat:i.values[0].lat,lng:i.values[0].lng,status:i.values[0].status,creation_date:i.values[0].creation_date,update_date:i.values[0].update_date,external_id:i.values[0].id,user_id:i.values[0].user_id},d=o.values.map(a=>({value:a.value,notes:a.notes,creation_date:a.creation_date,update_date:a.update_date,question_id:a.question_id}));this.auditoryService.upload({auditory:c,answers:d}).subscribe({next:a=>{const p=a.data.id;this.auditoryService.updateExternalId(t,p).subscribe({next:r=>{r!==h.W&&setTimeout(()=>{this.uploadAuditoryPhotos(t,p)},20)}})},error:a=>this.responseService.onError(a,"No se pudo subir la auditor\xeda")})}}})},20)}})})}uploadAuditoryPhotos(t,i){this.auditoryEvidenceService.getEvidencesByAuditory(t).subscribe({next:o=>(0,m.mG)(this,void 0,void 0,function*(){o!==h.W&&this.uploadAuditoryEvidence(o.values,0,i).then(c=>{this.uploadAnswerPhotos(t,i)})})})}uploadAuditoryEvidence(t,i,o){return(0,m.mG)(this,void 0,void 0,function*(){return new Promise((d,l)=>(0,m.mG)(this,void 0,void 0,function*(){if(i===t.length)return d(!0);const a=yield this.photoService.getLocalAuditoryEvidenceUri(t[i].dir).then(r=>r.uri),p=yield fetch(L.dV.convertFileSrc(a)).then(r=>r.blob());this.auditoryEvidenceService.uploadImage(p,o,t[i].creation_date,t[i].dir).subscribe({next:()=>{this.photoService.removeLocalAuditoryEvidence(t[i].dir).then(()=>{this.auditoryEvidenceService.localRemove(t[i].dir).subscribe({next:r=>{r!==h.W&&this.uploadAuditoryEvidence(t,i+1,o).then(f=>d(f))}})})},error:r=>this.responseService.onError(r,"No se pudo subir la imagen")})}))})}uploadAnswerPhotos(t,i){this.answerEvidenceService.getEvidencesByAuditory(t).subscribe({next:o=>(0,m.mG)(this,void 0,void 0,function*(){o!==h.W&&setTimeout(()=>{this.uploadAnswersEvidence(o.values,0,i).then(c=>{this.answerService.deleteAnswersByAuditory(t).subscribe({next:d=>{d!==h.W&&setTimeout(()=>{this.auditoryService.finalDelete(t).subscribe({next:l=>{l!==h.W&&(this.responseService.onSuccess("Auditor\xeda enviada exit\xf3samente"),setTimeout(()=>{this.fetchLocalList()},100))}})},20)}})})},20)})})}uploadAnswersEvidence(t,i,o){return(0,m.mG)(this,void 0,void 0,function*(){return new Promise((d,l)=>(0,m.mG)(this,void 0,void 0,function*(){if(i===t.length)return d(!0);const a=yield this.photoService.getLocalAnswerEvidenceUri(t[i].dir).then(r=>r.uri),p=yield fetch(L.dV.convertFileSrc(a)).then(r=>r.blob());this.answerEvidenceService.uploadImage(p,o,t[i].question_id,t[i].creation_date,t[i].dir).subscribe({next:()=>{this.photoService.removeLocalAnswerEvidence(t[i].dir).then(()=>{this.answerEvidenceService.localRemove(t[i].dir).subscribe({next:r=>{r!==h.W&&setTimeout(()=>{this.uploadAnswersEvidence(t,i+1,o).then(f=>d(f))},20)}})})},error:r=>this.responseService.onError(r,"No se pudo subir la imagen")})}))})}onDelete(t){this.confirmDialogService.presentAlert("\xbfDesea eliminar la auditor\xeda?",()=>{this.loadingService.showLoading(),this.auditoryService.deleteLocal(t).subscribe({next:i=>{i!==h.W&&(this.responseService.onSuccess("Auditor\xeda eliminada"),setTimeout(()=>{this.fetchLocalList()},100))},error:i=>{this.responseService.onError(i,"No se pudo eliminar la auditor\xeda")}})})}onRemoteDetail(t){this.router.navigateByUrl((0,g.Zo)(t))}onDownloadPdf(t,i){this.confirmDialogService.presentAlert("\xbfDesea descargar la auditor\xeda?",()=>{this.loadingService.showLoading(),this.auditoryService.downloadPdf(t).subscribe({next:o=>{const c=o,d="data.pdf";if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(c,d);else{const l=window.document.createElement("a");l.href=window.URL.createObjectURL(new Blob([c],{type:"application/pdf"})),l.download=d,document.body.appendChild(l),l.click(),document.body.removeChild(l)}},error:o=>this.responseService.onError(o,"No se pudo descargar la auditor\xeda")})})}presentActionSheetOptions(t){return(0,m.mG)(this,void 0,void 0,function*(){const i=this.sendedList?[{text:"Ver",handler:()=>this.onRemoteDetail(t.id)},{text:"Descargar",handler:()=>this.onDownloadPdf(t.id,t.title)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]:1===t.status?t.answersCompleted?[{text:"Actualizar datos generales",handler:()=>this.onEdit(t.id)},{text:"Actualizar Respuestas",handler:()=>this.onEditAnswers(t.id,1)},{text:"Eliminar Auditor\xeda",role:"destructive",handler:()=>this.onDelete(t.id)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]:[{text:"Actualizar datos generales",handler:()=>this.onEdit(t.id)},{text:"Actualizar Respuestas",handler:()=>this.onEditAnswers(t.id,t.lastIndex)},{text:"Eliminar Auditor\xeda",role:"destructive",handler:()=>this.onDelete(t.id)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]:[{text:"Actualizar datos generales",handler:()=>this.onEdit(t.id)},{text:"Actualizar Respuestas",handler:()=>this.onEditAnswers(t.id,1)},{text:"Env\xedar Auditor\xeda",handler:()=>this.onUpload(t.id)},{text:"Eliminar Auditor\xeda",role:"destructive",handler:()=>this.onDelete(t.id)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}];yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:i})).present()})}fetchLocalList(){this.sendedList=!1,this.loadingService.showLoading(),this.loading=!0,this.auditoryService.getLocalList().subscribe({next:t=>{t!==h.W&&(this.auditories=t.map(i=>Object.assign(Object.assign({},i),{statusWord:1===i.status?"En progreso":"Terminada"})),this.loading=!1,this.loadingService.dismissLoading())},error:t=>{this.responseService.onError(t,"No se pudieron recuperar las auditor\xedas")}})}fetchRemoteList(){this.sendedList=!0,this.loadingService.showLoading(),this.auditoryService.getRemoteList().subscribe({next:t=>{this.sendedList=!0,this.auditories=t.data.map(i=>Object.assign(Object.assign({},i),{statusWord:1===i.status?"En progreso":"Terminada"})),this.loadingService.dismissLoading()},error:t=>{this.responseService.onError(t,"No se pudieron recuperar las auditor\xedas"),this.fetchLocalList()}})}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(E.P),e.Y36(y.A),e.Y36(x.P),e.Y36(w.N),e.Y36(_.T),e.Y36(U.J),e.Y36(P.b),e.Y36(A.F0),e.Y36(T.D),e.Y36(u.BX),e.Y36(A.gz),e.Y36(u.t4))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-auditory-list"]],decls:15,vars:6,consts:[[3,"customButton","backUrl"],[1,"mx-2","mt-2"],["class","text-center",4,"ngIf"],["class","mt-2 txtInput",4,"ngFor","ngForOf"],["expand","full",3,"disabled","click"],[1,"text-center"],[1,"mt-2"],[3,"click"],[1,"mt-2","txtInput"],[1,"text-start"],[4,"ngIf"],["slot","end","size","small",3,"click",4,"ngIf"],["slot","end","size","small",3,"click"],["slot","icon-only","name","menu"],["slot","icon-only","name","eye"]],template:function(t,i){1&t&&(e.TgZ(0,"ion-content"),e._UZ(1,"app-header-buttons",0),e.TgZ(2,"div",1)(3,"h1"),e._uU(4,"Auditor\xedas"),e.qZA(),e.YNc(5,Z,5,0,"div",2),e.YNc(6,Y,9,5,"ion-item",3),e.qZA()(),e.TgZ(7,"ion-footer")(8,"ion-row")(9,"ion-col")(10,"ion-button",4),e.NdJ("click",function(){return i.fetchLocalList()}),e._uU(11,"SIN ENVIAR"),e.qZA()(),e.TgZ(12,"ion-col")(13,"ion-button",4),e.NdJ("click",function(){return i.fetchRemoteList()}),e._uU(14,"ENVIADAS"),e.qZA()()()()),2&t&&(e.xp6(1),e.Q6J("customButton",i.customButton)("backUrl",i.backUri),e.xp6(4),e.Q6J("ngIf",!i.loading&&0===i.auditories.length),e.xp6(1),e.Q6J("ngForOf",i.auditories),e.xp6(4),e.Q6J("disabled",!i.sendedList),e.xp6(3),e.Q6J("disabled",i.sendedList))},dependencies:[b.sg,b.O5,u.YG,u.wI,u.W2,u.fr,u.gu,u.Ie,u.Q$,u.Nd,D.$],encapsulation:2}),s})();var C=n(1576);const J=[{path:"",component:W}];let R=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[b.ez,u.Pc,A.Bz.forChild(J),C.Y]}),s})()}}]);