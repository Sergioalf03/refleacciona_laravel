"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1691],{6769:(C,b,r)=>{r.d(b,{$:()=>y});var o=r(8256),a=r(1433),l=r(6895),d=r(4731);function p(s,t){if(1&s){const h=o.EpF();o.TgZ(0,"div",3)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(h);const f=o.oxw();return o.KtG(f.onGoingBack())}),o._UZ(2,"ion-icon",5),o.qZA()()}}function I(s,t){if(1&s){const h=o.EpF();o.TgZ(0,"div",6)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(h);const f=o.oxw();return o.KtG(f.onGoingHome())}),o._UZ(2,"ion-icon",7),o.qZA()()}}function x(s,t){if(1&s){const h=o.EpF();o.TgZ(0,"div",6)(1,"ion-button",4),o.NdJ("click",function(){o.CHM(h);const f=o.oxw();return o.KtG(f.customButton.click())}),o._UZ(2,"ion-icon",8),o.qZA()()}if(2&s){const h=o.oxw();o.xp6(2),o.Q6J("name",h.customButton.icon)}}let y=(()=>{class s{constructor(h){this.router=h}ngOnInit(){}onGoingHome(){this.router.navigateByUrl(this.homeUrl)}onGoingBack(){this.router.navigateByUrl(this.backUrl)}}return s.\u0275fac=function(h){return new(h||s)(o.Y36(a.F0))},s.\u0275cmp=o.Xpm({type:s,selectors:[["app-header-buttons"]],inputs:{homeUrl:"homeUrl",backUrl:"backUrl",customButton:"customButton"},decls:4,vars:3,consts:[[1,"row","mt-2","mx-0"],["class","col",4,"ngIf"],["class","col text-end",4,"ngIf"],[1,"col"],["size","small",3,"click"],["slot","icon-only","name","arrow-back-outline"],[1,"col","text-end"],["slot","icon-only","name","home-sharp"],["slot","icon-only",3,"name"]],template:function(h,S){1&h&&(o.TgZ(0,"div",0),o.YNc(1,p,3,0,"div",1),o.YNc(2,I,3,0,"div",2),o.YNc(3,x,3,1,"div",2),o.qZA()),2&h&&(o.xp6(1),o.Q6J("ngIf",S.backUrl),o.xp6(1),o.Q6J("ngIf",S.homeUrl),o.xp6(1),o.Q6J("ngIf",S.customButton))},dependencies:[l.O5,d.YG,d.gu],encapsulation:2}),s})()},1576:(C,b,r)=>{r.d(b,{Y:()=>d});var o=r(6895),a=r(4731),l=r(8256);let d=(()=>{class p{}return p.\u0275fac=function(x){return new(x||p)},p.\u0275mod=l.oAB({type:p}),p.\u0275inj=l.cJS({imports:[o.ez,a.Pc]}),p})()},1691:(C,b,r)=>{r.r(b),r.d(b,{AuditoryFormPageModule:()=>W});var o=r(6895),a=r(433),l=r(4731),d=r(655),p=r(6090),I=r(4464),x=r(7423),y=r(7368),s=r(313),t=r(8256),h=r(1032),S=r(6118),f=r(1433),E=r(6572),U=r(2414),Z=r(3916),P=r(6250),F=r(6280),B=r(2424),N=r(1481),G=r(1006),M=r(6769);function J(c,g){if(1&c){const e=t.EpF();t.TgZ(0,"img",22),t.NdJ("click",function(){const n=t.CHM(e),u=n.$implicit,m=n.index,v=t.oxw(3);return t.KtG(v.onImgClicked(u.id,m))}),t.qZA()}if(2&c){const e=g.$implicit;t.Q6J("src",e.url,t.LSH)("ngStyle",e.expand)}}function w(c,g){if(1&c){const e=t.EpF();t.TgZ(0,"ion-button",23),t.NdJ("click",function(){t.CHM(e);const n=t.oxw(3);return t.KtG(n.onAddPhoto())}),t._UZ(1,"ion-icon",24),t.qZA()}}function D(c,g){if(1&c&&(t.TgZ(0,"ion-row")(1,"ion-col",19),t.YNc(2,J,1,2,"img",20),t.YNc(3,w,2,0,"ion-button",21),t.qZA()()),2&c){const e=t.oxw(2);t.xp6(1),t.Q6J("size",12),t.xp6(1),t.Q6J("ngForOf",e.ImageSrc),t.xp6(1),t.Q6J("ngIf",e.ImageSrc.length<10)}}function H(c,g){if(1&c){const e=t.EpF();t.TgZ(0,"form",4),t.NdJ("ngSubmit",function(){t.CHM(e);const n=t.oxw();return t.KtG(n.onSubmit())}),t.TgZ(1,"div",5)(2,"h1"),t._uU(3),t.qZA(),t.TgZ(4,"ion-item",6)(5,"ion-label",7),t._uU(6,"*T\xedtulo"),t.qZA(),t._UZ(7,"ion-input",8),t.qZA(),t.TgZ(8,"ion-item",9)(9,"ion-label",7),t._uU(10,"*Fecha"),t.qZA(),t._UZ(11,"ion-input",10),t.qZA(),t.TgZ(12,"ion-item",9)(13,"ion-label",7),t._uU(14,"*Hora"),t.qZA(),t._UZ(15,"ion-input",11),t.qZA(),t.TgZ(16,"ion-item",12)(17,"ion-label",7),t._uU(18,"Descripci\xf3n"),t.qZA(),t._UZ(19,"ion-textarea",13),t.qZA(),t._UZ(20,"ion-input",14)(21,"ion-input",15),t.TgZ(22,"app-map",16),t.NdJ("centerEvent",function(n){t.CHM(e);const u=t.oxw();return t.KtG(u.onSetCoords(n))}),t.qZA(),t.TgZ(23,"ion-button",17),t.NdJ("click",function(){t.CHM(e);const n=t.oxw();return t.KtG(n.onAddLocation())}),t._uU(24,"UBICACI\xd3N ACTUAL"),t.qZA(),t.YNc(25,D,4,3,"ion-row",18),t.qZA()()}if(2&c){const e=t.oxw();t.Q6J("formGroup",e.form),t.xp6(3),t.hij("",e.formActionText," Auditor\xeda"),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("clearInput",!0),t.xp6(4),t.Q6J("autoGrow",!0),t.xp6(6),t.Q6J("ngIf",e.ImageSrc)}}let L=(()=>{class c{constructor(e,i,n,u,m,v,A,_,T,z,Q,K,R){this.auditoryService=e,this.auditoryEvidenceService=i,this.router=n,this.route=u,this.validFormService=m,this.responseService=v,this.mapService=A,this.photoService=_,this.confirmDialogService=T,this.actionSheetCtrl=z,this.loadingService=Q,this.sanitization=K,this.platform=R,this.formActionText="Nueva",this.SubmitButtonText="Comenzar",this.auditoryId="0",this.backUrl=(0,y.CE)(),this.locationAdded=!1,this.hideMap=!0,this.ImageSrc=[],this.platform.backButton.subscribeWithPriority(9999,()=>{this.router.navigateByUrl(this.backUrl)})}ngOnDestroy(){}initForm(){const e=new Date;e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.setSeconds(0);const i=e.toISOString().split("T"),n=i[1].split(".");this.form=new a.cw({title:new a.NI("",{validators:[a.kI.required]}),description:new a.NI(""),date:new a.NI(i[0],{validators:[a.kI.required,a.kI.minLength(1)]}),time:new a.NI(n[0],{validators:[a.kI.required,a.kI.minLength(1)]}),lat:new a.NI(""),lng:new a.NI("")})}createAuditory(e){return(0,d.mG)(this,void 0,void 0,function*(){this.auditoryService.localSave(e).subscribe({next:i=>{i!==s.W&&setTimeout(()=>{this.auditoryService.getLastSavedId().subscribe({next:n=>(0,d.mG)(this,void 0,void 0,function*(){n!==s.W&&setTimeout(()=>{this.hideMap=!0,this.auditoryId=n.values[0].id;let u=0;this.ImageSrc.length>0?this.ImageSrc.forEach((m,v)=>(0,d.mG)(this,void 0,void 0,function*(){const A=yield fetch(m.base64).then(_=>_.blob());this.photoService.saveLocalAuditoryEvidence(A,this.auditoryId).then(_=>{setTimeout(()=>(0,d.mG)(this,void 0,void 0,function*(){this.auditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:_}).subscribe({next:T=>(0,d.mG)(this,void 0,void 0,function*(){T!==s.W&&(u++,u===this.ImageSrc.length&&this.responseService.onSuccessAndRedirect((0,y.vk)("0",this.auditoryId,"1"),"Auditor\xeda guarda"))}),error:T=>{this.responseService.onError(T,"No se pudo guardar una imagen")}})}),50*v)}).catch(_=>this.responseService.onError(_,"No se pudo guardar la imagen"))})):this.responseService.onSuccessAndRedirect((0,y.vk)("0",this.auditoryId,"1"),"Auditor\xeda guarda")},20)})})},20)},error:i=>{this.responseService.onError(i,"No se pudo guardar")}})})}updateAuditory(e){this.auditoryService.updateLocal(this.auditoryId,e).subscribe({next:i=>{i!==s.W&&(this.hideMap=!0,this.responseService.onSuccessAndRedirect((0,y.Zh)("local"),"Auditor\xeda actualizada"))},error:i=>{this.responseService.onError(i,"No se pudo actualizar")}})}setAuditory(e){this.backUrl=(0,y.Zh)("local"),this.form.setValue({title:e.title,description:e.description,date:e.date,time:e.time,lat:e.lat,lng:e.lng}),this.auditoryEvidenceService.getEvidencesByAuditory(this.auditoryId).subscribe({next:i=>{i!==s.W&&((0,I.n$)("hybrid")?i.values.forEach(n=>(0,d.mG)(this,void 0,void 0,function*(){this.photoService.getLocalAuditoryEvidenceUri(n.dir).then(u=>{this.ImageSrc.push({id:n.dir,url:x.dV.convertFileSrc(u.uri),base64:"",expand:{width:"25%"}})})})):i.values.forEach(n=>(0,d.mG)(this,void 0,void 0,function*(){this.photoService.getLocalAuditoryEvidence(n.dir).then(u=>{const m="data:image/png;base64,"+u.data;this.ImageSrc.push({id:n.dir,url:m,base64:m,expand:{width:"25%"}})})})))}}),setTimeout(()=>{this.mapService.setCenter(e.lat,e.lng),this.loadingService.dismissLoading()},1e3)}ngOnInit(){this.hideMap=!0}ionViewWillEnter(){this.initForm(),this.route.paramMap.subscribe({next:e=>{let i=e.get("id")||"0";"00"===i&&(this.backUrl=(0,y.Zh)("local"),i="0"),"0"!==i&&(this.loadingService.showLoading(),this.auditoryId=i,this.formActionText="Actualizando",this.SubmitButtonText="Guardar",this.auditoryService.getLocalForm(this.auditoryId).subscribe({next:n=>{n!==s.W&&setTimeout(()=>{this.setAuditory(n.values[0])},20)},error:n=>{this.responseService.onError(n,"No se pudieron recuperar los datos")}}))}}).unsubscribe()}ionViewWillLeave(){this.formActionText="Nueva",this.SubmitButtonText="Comenzar",this.auditoryId="0",this.locationAdded=!1,this.form=new a.cw({}),this.ImageSrc=[],this.hideMap=!0}onSubmit(){this.validFormService.isValid(this.form,[])&&this.confirmDialogService.presentAlert("\xbfDesea guardar los cambios?",()=>{this.loadingService.showLoading(),this.mapService.setCenter(0,0);const e={title:this.form.controls.title.value,description:this.form.controls.description.value,date:this.form.controls.date.value,time:this.form.controls.time.value,lat:this.form.controls.lat.value,lng:this.form.controls.lng.value};"0"===this.auditoryId?this.createAuditory(e):this.updateAuditory(e)})}onAddLocation(){return(0,d.mG)(this,void 0,void 0,function*(){this.hideMap=!1;const e=yield p.b.getCurrentPosition({enableHighAccuracy:!0});this.mapService.setCenter(e.coords.latitude,e.coords.longitude)})}onCancel(){this.router.navigateByUrl(this.backUrl)}onAddPhoto(){return(0,d.mG)(this,void 0,void 0,function*(){yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:[{text:"C\xe1mara",handler:()=>this.fromCamera()},{text:"Galer\xeda",handler:()=>this.fromGallery()},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]})).present()})}fromGallery(){this.photoService.openGallery().then(e=>(0,d.mG)(this,void 0,void 0,function*(){if("0"===this.auditoryId)for(let i=0;i<e.photos.length;i++)this.ImageSrc.push({id:"",url:this.sanitization.bypassSecurityTrustUrl(e.photos[i].webPath),base64:e.photos[i].webPath,expand:{width:"25%"}});else for(let i=0;i<e.photos.length;i++){const n=e.photos[i].webPath,u=yield fetch(n).then(m=>m.blob());this.photoService.saveLocalAuditoryEvidence(u,this.auditoryId).then(m=>{m!==s.W&&this.auditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:m}).subscribe({next:v=>(0,d.mG)(this,void 0,void 0,function*(){v!==s.W&&setTimeout(()=>{this.auditoryEvidenceService.getLastInsertedDir().subscribe({next:A=>(0,d.mG)(this,void 0,void 0,function*(){A!==s.W&&this.ImageSrc.push({id:A.values[0].dir,url:this.sanitization.bypassSecurityTrustUrl(n),base64:n,expand:{width:"25%"}})})})},20)}),error:v=>{this.responseService.onError(v,"No se pudo guardar una imagen")}})})}}))}fromCamera(){this.photoService.takePicture().then(e=>(0,d.mG)(this,void 0,void 0,function*(){if("0"===this.auditoryId)this.ImageSrc.push({id:"",url:this.sanitization.bypassSecurityTrustUrl(e.webPath||""),base64:e.webPath||"",expand:{width:"25%"}});else{const i=e.webPath||"",n=yield fetch(i).then(u=>u.blob());this.photoService.saveLocalAuditoryEvidence(n,this.auditoryId).then(u=>{u!==s.W&&this.auditoryEvidenceService.localSave({auditoryId:this.auditoryId,dir:u}).subscribe({next:m=>(0,d.mG)(this,void 0,void 0,function*(){m!==s.W&&setTimeout(()=>{this.auditoryEvidenceService.getLastInsertedDir().subscribe({next:v=>(0,d.mG)(this,void 0,void 0,function*(){v!==s.W&&this.ImageSrc.push({id:v.values[0].dir,url:this.sanitization.bypassSecurityTrustUrl(i),base64:i,expand:{width:"25%"}})})})},20)}),error:m=>{this.responseService.onError(m,"No se pudo guardar una imagen")}})})}}))}onSetCoords(e){this.form.controls.lat.setValue(e.lat),this.form.controls.lng.setValue(e.lng)}onImgClicked(e,i){return(0,d.mG)(this,void 0,void 0,function*(){yield(yield this.actionSheetCtrl.create({header:"Opciones",mode:"ios",buttons:[{text:"Cambiar tama\xf1o",handler:()=>this.onChangeSize(i)},{text:"Eliminar Foto",role:"destructive",handler:()=>this.onRemove(e,i)},{text:"Cerrar",role:"cancel",data:{action:"cancel"}}]})).present()})}onChangeSize(e){this.ImageSrc[e].expand="25%"===this.ImageSrc[e].expand.width?{width:"100%"}:{width:"25%"}}onRemove(e,i){this.confirmDialogService.presentAlert("\xbfDesea eliminar la imagen?",()=>{e?this.auditoryEvidenceService.localRemove(e).subscribe({next:()=>{this.photoService.removeLocalAuditoryEvidence(e).then(()=>this.ImageSrc.splice(i,1))}}):this.ImageSrc.splice(i,1)})}}return c.\u0275fac=function(e){return new(e||c)(t.Y36(h.P),t.Y36(S.A),t.Y36(f.F0),t.Y36(f.gz),t.Y36(E.i),t.Y36(U.J),t.Y36(Z.S),t.Y36(P.T),t.Y36(F.D),t.Y36(l.BX),t.Y36(B.b),t.Y36(N.H7),t.Y36(l.t4))},c.\u0275cmp=t.Xpm({type:c,selectors:[["app-auditory-form"]],hostBindings:function(e,i){1&e&&t.NdJ("unloaded",function(){return i.ngOnDestroy()})},decls:11,vars:3,consts:[["homeUrl","/home",3,"backUrl"],[3,"formGroup","ngSubmit",4,"ngIf"],["color","danger","expand","full",3,"click"],["expand","full","type","button",3,"click"],[3,"formGroup","ngSubmit"],[1,"mx-2","mt-4"],[1,"mt-4","txtInput"],["position","floating"],["formControlName","title","type","text","placeholder","Escriba un t\xedtulo",3,"clearInput"],[1,"mt-2","txtInput"],["formControlName","date","type","date","placeholder","Escriba el sentido",3,"clearInput"],["formControlName","time","type","time","placeholder","Escriba el sentido",3,"clearInput"],[1,"mt-2","txtInput","mb-2"],["formControlName","description","type","text","rows","3","placeholder","Agregue una descripci\xf3n",3,"autoGrow"],["formControlName","lat","type","hidden","hidden",""],["formControlName","lng","type","hidden","hidden",""],[3,"centerEvent"],["expand","full","color","light",1,"mt-3",3,"click"],[4,"ngIf"],[3,"size"],[3,"src","ngStyle","click",4,"ngFor","ngForOf"],["class","btn-right","fill","clear","size","large",3,"click",4,"ngIf"],[3,"src","ngStyle","click"],["fill","clear","size","large",1,"btn-right",3,"click"],["slot","icon-only","name","image-outline",1,"icon-color"]],template:function(e,i){1&e&&(t.TgZ(0,"ion-content"),t._UZ(1,"app-header-buttons",0),t.YNc(2,H,26,7,"form",1),t.qZA(),t.TgZ(3,"ion-footer")(4,"ion-row")(5,"ion-col")(6,"ion-button",2),t.NdJ("click",function(){return i.onCancel()}),t._uU(7," CANCELAR "),t.qZA()(),t.TgZ(8,"ion-col")(9,"ion-button",3),t.NdJ("click",function(){return i.onSubmit()}),t._uU(10),t.qZA()()()()),2&e&&(t.xp6(1),t.Q6J("backUrl",i.backUrl),t.xp6(1),t.Q6J("ngIf",i.form),t.xp6(8),t.hij(" ",i.SubmitButtonText," "))},dependencies:[o.sg,o.O5,o.PC,a._Y,a.JJ,a.JL,a.sg,a.u,l.YG,l.wI,l.W2,l.fr,l.gu,l.pK,l.Ie,l.Q$,l.Nd,l.g2,l.j9,G.G,M.$],encapsulation:2}),c})();var O=r(3375),Y=r(1576);const k=[{path:"",component:L}];let W=(()=>{class c{}return c.\u0275fac=function(e){return new(e||c)},c.\u0275mod=t.oAB({type:c}),c.\u0275inj=t.cJS({imports:[o.ez,a.UX,a.u5,l.Pc,f.Bz.forChild(k),O.R,Y.Y]}),c})()}}]);